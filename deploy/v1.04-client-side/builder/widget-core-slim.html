<script>
/**
 * Club Events/Calendar Widget
 * ═══════════════════════════════════════════════════════════════════════════
 *
 * This file contains the embeddable events/calendar widget for Santa Barbara
 * Newcomers Club. It is designed to be embedded in Wild Apricot pages.
 *
 * ┌─────────────────────────────────────────────────────────────────────────┐
 * │  CODE ORGANIZATION - READ THIS FIRST                                   │
 * ├─────────────────────────────────────────────────────────────────────────┤
 * │                                                                         │
 * │  This code has TWO distinct parts:                                     │
 * │                                                                         │
 * │  1. EXTERNAL LIBRARIES (loaded from CDN - we don't maintain these)     │
 * │     - FullCalendar: Calendar display and navigation                    │
 * │     - Vanilla JS: DOM manipulation (no jQuery required)                │
 * │                                                                         │
 * │  2. CLUBCALENDAR SHIM (this file - we maintain this code)                      │
 * │     Organized into three broad categories:                             │
 * │                                                                         │
 * │     A. SETTINGS (Sections 1-2) - What to show and how it looks         │
 * │        ├── Configuration: Default values, API URLs, feature flags      │
 * │        └── CSS Overrides: Styling to match WA theme                    │
 * │                                                                         │
 * │     B. DATA LAYER (Section 3) - Where data comes from                  │
 * │        └── API Integration: Fetches events from WA database            │
 * │                                                                         │
 * │     C. UI LAYER (Sections 4-6) - How it all works together             │
 * │        ├── Widget Integration: HTML, filters, calendar rendering       │
 * │        ├── Public API: External access points                          │
 * │        └── Initialization: Startup sequence                            │
 * │                                                                         │
 * └─────────────────────────────────────────────────────────────────────────┘
 *
 *
 * ┌─────────────────────────────────────────────────────────────────────────┐
 * │  CODE ANALYSIS - Maintenance Guide                                     │
 * ├─────────────────────────────────────────────────────────────────────────┤
 * │                                                                         │
 * │  SECTION BREAKDOWN (% of code, dependencies, stability)                │
 * │                                                                         │
 * │  ┌─────────────────────────────────────────────────────────────────┐   │
 * │  │ CATEGORY A: SETTINGS (~25% of code)                             │   │
 * │  │ Overall stability: HIGH - Changes rarely needed                 │   │
 * │  ├─────────────────────────────────────────────────────────────────┤   │
 * │  │                                                                 │   │
 * │  │ Section 1: Configuration                                        │   │
 * │  │   Lines: ~80 (~6%)                                              │   │
 * │  │   Dependencies: None                                            │   │
 * │  │   Stability: HIGH                                               │   │
 * │  │   Break risk: LOW - Only breaks if server URL changes           │   │
 * │  │   Reason to change: Server migration, new features              │   │
 * │  │                                                                 │   │
 * │  │ Section 2: CSS Overrides                                        │   │
 * │  │   Lines: ~250 (~19%)                                            │   │
 * │  │   Dependencies: None (pure CSS)                                 │   │
 * │  │   Stability: HIGH                                               │   │
 * │  │   Break risk: LOW - Visual only, won't break functionality      │   │
 * │  │   Reason to change: WA theme update, design refresh             │   │
 * │  │                                                                 │   │
 * │  └─────────────────────────────────────────────────────────────────┘   │
 * │                                                                         │
 * │  ┌─────────────────────────────────────────────────────────────────┐   │
 * │  │ CATEGORY B: DATA LAYER (~12% of code)                           │   │
 * │  │ Overall stability: MEDIUM - May need updates with backend       │   │
 * │  ├─────────────────────────────────────────────────────────────────┤   │
 * │  │                                                                 │   │
 * │  │ Section 3: API Integration                                      │   │
 * │  │   Lines: ~150 (~12%)                                            │   │
 * │  │   Dependencies: fetch API (browser built-in)                    │   │
 * │  │   Stability: MEDIUM                                             │   │
 * │  │   Break risk: MEDIUM - Breaks if API changes                    │   │
 * │  │   Reason to change: Backend API changes, new data fields        │   │
 * │  │   Watch for: Endpoint URL changes, response format changes      │   │
 * │  │                                                                 │   │
 * │  └─────────────────────────────────────────────────────────────────┘   │
 * │                                                                         │
 * │  ┌─────────────────────────────────────────────────────────────────┐   │
 * │  │ CATEGORY C: UI LAYER (~63% of code)                             │   │
 * │  │ Overall stability: MEDIUM - Core functionality lives here       │   │
 * │  ├─────────────────────────────────────────────────────────────────┤   │
 * │  │                                                                 │   │
 * │  │ Section 4: Widget Integration                                   │   │
 * │  │   Lines: ~600 (~47%)                                            │   │
 * │  │   Dependencies: FullCalendar only (vanilla JS for DOM)          │   │
 * │  │   Stability: MEDIUM                                             │   │
 * │  │   Break risk: MEDIUM-HIGH                                       │   │
 * │  │   Reason to change: New filters, layout changes, lib updates    │   │
 * │  │   Watch for: Library version updates, API changes               │   │
 * │  │   Sub-sections:                                                 │   │
 * │  │     - Dependency Loading: LOW risk (stable CDN URLs)            │   │
 * │  │     - HTML Construction: LOW risk (pure string templates)       │   │
 * │  │     - Filter Logic: MEDIUM risk (ties to data & UI)             │   │
 * │  │     - Calendar Rendering: MEDIUM-HIGH (FullCalendar dependent)  │   │
 * │  │                                                                 │   │
 * │  │ Section 5: Public API                                           │   │
 * │  │   Lines: ~40 (~3%)                                              │   │
 * │  │   Dependencies: Internal functions only                         │   │
 * │  │   Stability: HIGH                                               │   │
 * │  │   Break risk: LOW - Simple function exports                     │   │
 * │  │   Reason to change: Adding new public methods                   │   │
 * │  │   IMPORTANT: Don't remove methods (external code may use them)  │   │
 * │  │                                                                 │   │
 * │  │ Section 6: Initialization                                       │   │
 * │  │   Lines: ~50 (~4%)                                              │   │
 * │  │   Dependencies: All other sections                              │   │
 * │  │   Stability: HIGH                                               │   │
 * │  │   Break risk: LOW - Simple orchestration                        │   │
 * │  │   Reason to change: New startup steps, loading order changes    │   │
 * │  │                                                                 │   │
 * │  └─────────────────────────────────────────────────────────────────┘   │
 * │                                                                         │
 * │  EXTERNAL LIBRARY RISK ASSESSMENT                                      │
 * │  ─────────────────────────────────────────────────────────────────────  │
 * │                                                                         │
 * │  FullCalendar (v6.x)                                                   │
 * │    Risk: MEDIUM - Active development, breaking changes between majors  │
 * │    Pinned to: Major version 6                                          │
 * │    Watch for: Options renamed, deprecated features                     │
 * │    Mitigation: Test after any version update                           │
 * │                                                                         │
 * │  Note: jQuery dependency removed in v1.02 - using vanilla JS           │
 * │                                                                         │
 * └─────────────────────────────────────────────────────────────────────────┘
 *
 * @version 1.04-slim
 * @author ClubCalendar
 */

(function() {
    'use strict';

/* ╔═══════════════════════════════════════════════════════════════════════════╗
   ║                                                                           ║
   ║                     EXTERNAL LIBRARIES DOCUMENTATION                      ║
   ║                                                                           ║
   ║  These libraries are loaded from CDN. We DO NOT maintain this code.      ║
   ║  Documentation links for reference when troubleshooting:                 ║
   ║                                                                           ║
   ║  FullCalendar (v6.x)                                                     ║
   ║  ─────────────────────────────────────────────────────────────────────   ║
   ║  Purpose: Calendar display, event rendering, date navigation             ║
   ║  Docs: https://fullcalendar.io/docs                                      ║
   ║  CDN: https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.8                        ║
   ║  Key methods we use:                                                     ║
   ║    - new FullCalendar.Calendar(el, options) - Initialize calendar        ║
   ║    - calendar.render() - Display the calendar                            ║
   ║    - calendar.refetchEvents() - Reload events from source                │
   ║    - calendar.changeView(viewName) - Switch between views                ║
   ║  Views: dayGridMonth, timeGridWeek, timeGridDay, listMonth               ║
   ║                                                                           ║
   ║  Note: jQuery removed in v1.02 - using vanilla JS for DOM operations    ║
   ║                                                                           ║
   ╚═══════════════════════════════════════════════════════════════════════════╝ */


/* ╔═══════════════════════════════════════════════════════════════════════════╗
   ║                                                                           ║
   ║                         CLUBCALENDAR SHIM - START                                 ║
   ║                                                                           ║
   ║  Everything below this line is ClubCalendar-specific code that we maintain.      ║
   ║                                                                           ║
   ╚═══════════════════════════════════════════════════════════════════════════╝ */


// ╔═══════════════════════════════════════════════════════════════════════════╗
// ║  CATEGORY A: SETTINGS                                                     ║
// ║  What to show and how it looks                                            ║
// ╚═══════════════════════════════════════════════════════════════════════════╝

// ═══════════════════════════════════════════════════════════════════════════
// SECTION 1: CONFIGURATION                                    [~6% of code]
// ═══════════════════════════════════════════════════════════════════════════
// Dependencies: None
// Stability: HIGH | Break risk: LOW
//
// This section contains ClubCalendar-specific default settings.
// These can be overridden by setting window.CLUBCALENDAR_CONFIG before loading.
//
// WHAT YOU MIGHT NEED TO CHANGE:
// - API endpoint URLs if server location changes
// - Default filter settings
// - Feature flags (showFilters, showHeader)
// ═══════════════════════════════════════════════════════════════════════════

    /**
     * @typedef {Object} CalendarConfig
     * @property {string} container - CSS selector for calendar container
     * @property {string} defaultView - Initial view mode ('month', 'week', 'list')
     * @property {boolean} showFilters - Whether to show filter controls
     * @property {boolean} showHeader - Whether to show calendar header
     * @property {string} headerTitle - Custom header title
     */

    /**
     * Default configuration values.
     * Override by setting window.CLUBCALENDAR_CONFIG before this script loads.
     *
     * @type {CalendarConfig}
     * @constant
     */
    const DEFAULT_CONFIG = {
        container: '#clubcalendar',          // Where to render the calendar
        waAccountId: '',                       // WA Account ID (required for client-side API)
        waClientId: '',                        // WA API Client ID (required for client-side API)
        useClientSideApi: false,               // Use WA Member API directly (no external server)
        defaultView: 'dayGridMonth',           // FullCalendar view name
        showFilters: true,                     // Show interest/committee/time filters
        showHeader: true,                      // Show "Club Events" header
        headerTitle: 'Club Events',            // Header title text
        showActivityFilter: true,              // Show activity group filter
        showTimeFilter: true,                  // Show time period filter
        showAvailabilityFilter: true,          // Show availability filter
        pastEventsVisible: false,              // Show past events
        pastEventsDays: 14,                    // Days of past events to show in calendar view
        pastEventsMonthsList: 6,               // Months of past events to show in list view
        futureMonthsLimit: 3,                  // How many months ahead to show
        eventClickBehavior: 'popup',           // 'popup', 'link', or 'both'
        primaryColor: '#2c5aa0',               // WA primary blue
        accentColor: '#d4a800',                // WA secondary gold
        // Typography customization
        fontFamily: null,                      // Custom font (e.g., 'Arial, sans-serif') - null uses system fonts
        baseFontSize: null,                    // Base font size (e.g., '15px') - null uses widget defaults
        cacheDuration: 300,                    // Seconds to cache events
        refreshInterval: 0,                    // Auto-refresh interval (0 = disabled)
        memberLevel: 'public',                 // Member level: 'Newbie', 'NewcomerMember', 'Alumni', 'Guest', or 'public' for anonymous
        showAddToCalendar: true,               // Show "Add to Calendar" button in event popup
        // Failover configuration
        fallbackContainerId: 'wa-fallback',    // ID of hidden WA calendar container to show on error
        fallbackEventsUrl: '/events'           // URL to link to if no fallback container exists
    };

    /**
     * Remote configuration loaded from /api/config.json
     * @type {Object|null}
     */
    let remoteConfig = null;

    /**
     * Merged configuration (defaults + remote + user overrides)
     * @type {CalendarConfig}
     */
    let CONFIG = Object.assign({}, DEFAULT_CONFIG, window.CLUBCALENDAR_CONFIG || {});


    // URL parameter override for testing: ?mode=member or ?mode=public
    const urlParams = new URLSearchParams(window.location.search);
    const modeParam = urlParams.get('mode');
    if (modeParam === 'member') {
        CONFIG.memberLevel = 'NewcomerMember';
        console.log('ClubCalendar: Testing as MEMBER (via URL param)');
    } else if (modeParam === 'public') {
        CONFIG.memberLevel = 'public';
        console.log('ClubCalendar: Testing as PUBLIC (via URL param)');
    }

    /**
     * Interest area keyword mappings for filtering events by content.
     * @constant
     */
    const INTEREST_KEYWORDS = {
        'food': ['dinner', 'lunch', 'brunch', 'restaurant', 'food', 'cooking', 'chef', 'cuisine', 'potluck', 'meal'],
        'wine': ['wine', 'winery', 'vineyard', 'tasting', 'sommelier'],
        'beer': ['beer', 'brewery', 'ale', 'lager', 'craft beer', 'pub'],
        'performing-arts': ['theater', 'theatre', 'concert', 'symphony', 'opera', 'ballet', 'play', 'musical', 'performance'],
        'visual-arts': ['gallery', 'museum', 'art walk', 'exhibit', 'artist', 'painting', 'sculpture'],
        'tours': ['tour', 'historic', 'heritage', 'architecture', 'walking tour', 'docent'],
        'outdoors': ['hike', 'hiking', 'trail', 'beach', 'park', 'outdoor', 'nature', 'canyon', 'mountain'],
        'athletic': ['golf', 'cycling', 'bike', 'sailing', 'kayak', 'pickleball', 'tennis', 'bowling'],
        'garden': ['garden', 'botanic', 'plant', 'flower', 'nursery'],
        'books': ['book', 'read', 'author', 'novel', 'literary'],
        'discussion': ['discussion', 'current events', 'foreign policy', 'politics', 'speaker'],
        'wellness': ['wellness', 'mindfulness', 'meditation', 'soundbath', 'healing'],
        'social': ['happy hour', 'social', 'mixer', 'networking', 'party'],
        'games': ['game', 'trivia', 'cards', 'canasta', 'bunco', 'billiards', 'board game']
    };

    /**
     * Committee prefix mappings for filtering events by organizer.
     * @constant
     */
    const COMMITTEE_KEYWORDS = {
        'Games!': ['Games!:', 'Games!'],
        'Wellness': ['Wellness:'],
        'Arts': ['Arts:', 'SB Arts:', 'Visual Arts:'],
        'Local Heritage': ['Local Heritage:'],
        'Wine Appreciation': ['Wine Appreciation:'],
        'Pop-Up': ['Pop-Up:', 'Pop Up:', 'POP UP:'],
        'Happy Hikers': ['Happy Hikers:'],
        'Garden': ['Garden:', 'Gardening:'],
        'Volunteers': ['Volunteers in Action:'],
        'Epicurious': ['Epicurious:'],
        'Current Events': ['Current Events:', 'Foreign Policy:'],
        'Book Clubs': ['Afternoon Book:', 'Evening Book:', 'Books and Bites:'],
        'TGIF': ['TGIF:'],
        'Performing Arts': ['Performing Arts:', 'Theater Lovers:'],
        'Golf': ['Golf:'],
        'Cycling': ['Cycling:'],
        'Beer Lovers': ['Beer Lovers:'],
        'Out to Lunch': ['Out to Lunch:']
    };


// ═══════════════════════════════════════════════════════════════════════════
// SECTION 1B: FILTER BUSINESS RULES                           [EASY TO FIND]
// ═══════════════════════════════════════════════════════════════════════════
// This section defines ALL filter business rules in one place.
//
// WHAT'S HERE:
// - Filter definitions (labels, colors, criteria)
// - Helper functions that evaluate if an event matches a filter
//
// TO ADD A NEW FILTER:
// 1. Add entry to FILTER_RULES below
// 2. Add CSS for dot/badge colors in Section 2
// 3. Add button HTML in buildWidgetHTML()
// ═══════════════════════════════════════════════════════════════════════════

    /**
     * FILTER BUSINESS RULES
     * ─────────────────────────────────────────────────────────────────────────
     * Each filter has:
     *   - id: unique identifier used in code
     *   - label: display text for buttons and badges
     *   - tooltip: hover text for calendar dots
     *   - dotColor: CSS color for the filter dot
     *   - badgeBg: badge background color (list view)
     *   - badgeText: badge text color (list view)
     *   - group: filter grouping for UI layout
     *   - criteria: function(event, context) => boolean
     *
     * The 'context' object passed to criteria contains:
     *   - now: current Date
     *   - eventDate: parsed event start date
     *   - dayOfWeek: 0=Sunday, 6=Saturday
     *   - eventHour: hour of event start (0-23)
     *   - tags: parsed event tags array
     *   - availability: event availability status object
     *   - isFree: boolean if event is free
     */
    const FILTER_RULES = {
        // ─────────────────────────────────────────────────────────────────────
        // REGISTRATION STATUS FILTERS
        // ─────────────────────────────────────────────────────────────────────
        justopened: {
            id: 'justopened',
            label: 'Just Opened',
            tooltip: 'Just Opened',
            dotColor: '#e91e63',        // Pink
            badgeBg: '#fce4ec',
            badgeText: '#c2185b',
            group: 'registration',
            criteria: (event, ctx) => {
                // Registration opened within the last 7 days
                if (!event.registrationOpenDate) return false;
                const regOpenDate = new Date(event.registrationOpenDate);
                const sevenDaysAgo = new Date(ctx.now);
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                return regOpenDate >= sevenDaysAgo && regOpenDate <= ctx.now;
            }
        },
        openingsoon: {
            id: 'openingsoon',
            label: 'Opening Soon',
            tooltip: 'Opening Soon',
            dotColor: '#009688',        // Teal
            badgeBg: '#e0f2f1',
            badgeText: '#00796b',
            group: 'registration',
            criteria: (event, ctx) => {
                // Registration opens within the next 7 days
                if (!event.registrationOpenDate) return false;
                const regOpenDate = new Date(event.registrationOpenDate);
                const sevenDaysFromNow = new Date(ctx.now);
                sevenDaysFromNow.setDate(sevenDaysFromNow.getDate() + 7);
                return regOpenDate > ctx.now && regOpenDate <= sevenDaysFromNow;
            }
        },
        openings: {
            id: 'openings',
            label: 'Openings for Any Member',
            tooltip: 'Openings for Any Member',
            dotColor: '#4caf50',        // Green
            badgeBg: '#e8f5e9',
            badgeText: '#2e7d32',
            group: 'registration',
            criteria: (event, ctx) => {
                // Event has available spots (not full)
                return ctx.availability && ctx.availability.status !== 'full';
            }
        },

        // ─────────────────────────────────────────────────────────────────────
        // TIMING FILTERS
        // ─────────────────────────────────────────────────────────────────────
        weekend: {
            id: 'weekend',
            label: 'Weekend',
            tooltip: 'Weekend',
            dotColor: '#9c27b0',        // Purple
            badgeBg: '#f3e5f5',
            badgeText: '#7b1fa2',
            group: 'timing',
            criteria: (event, ctx) => {
                // Saturday (6) or Sunday (0)
                return ctx.dayOfWeek === 0 || ctx.dayOfWeek === 6;
            }
        },
        afterhours: {
            id: 'afterhours',
            label: 'After Hours',
            tooltip: 'After Hours',
            dotColor: '#5c6bc0',        // Indigo
            badgeBg: '#e8eaf6',
            badgeText: '#3949ab',
            group: 'timing',
            criteria: (event, ctx) => {
                // Weekends OR after 5pm on weekdays
                const isWeekend = ctx.dayOfWeek === 0 || ctx.dayOfWeek === 6;
                const isAfter5pmWeekday = ctx.dayOfWeek >= 1 && ctx.dayOfWeek <= 5 && ctx.eventHour >= 17;
                return isWeekend || isAfter5pmWeekday;
            }
        },

        // ─────────────────────────────────────────────────────────────────────
        // COST & AUDIENCE FILTERS
        // ─────────────────────────────────────────────────────────────────────
        free: {
            id: 'free',
            label: 'Free',
            tooltip: 'Free',
            dotColor: '#ffc107',        // Yellow/Amber
            badgeBg: '#fff8e1',
            badgeText: '#f57f17',
            group: 'cost',
            criteria: (event, ctx) => {
                return ctx.isFree;
            }
        },
        newbie: {
            id: 'newbie',
            label: 'Openings for Newbies',
            tooltip: 'Openings for Newbies',
            dotColor: '#00bcd4',        // Cyan
            badgeBg: '#e0f7fa',
            badgeText: '#00838f',
            group: 'audience',
            criteria: (event, ctx) => {
                // Any event with openings has openings for newbies
                // (Newbies are members, so if there are spots available, newbies can register)
                return ctx.availability && ctx.availability.status !== 'full';
            }
        },
        public: {
            id: 'public',
            label: 'Open to Public',
            tooltip: 'Open to Public',
            dotColor: '#8bc34a',        // Light Green
            badgeBg: '#f1f8e9',
            badgeText: '#558b2f',
            group: 'audience',
            criteria: (event, ctx) => {
                // Event is open to non-members/public
                return ctx.tags.some(t =>
                    t.toLowerCase().includes('public event') ||
                    t.toLowerCase().includes('public')
                ) || event.hasGuestTickets === 1;
            }
        }
    };

    /**
     * TIME OF DAY DISPLAY RULES
     * ─────────────────────────────────────────────────────────────────────────
     * Controls the color coding for events based on start time.
     */
    const TIME_OF_DAY_RULES = {
        morning: {
            label: 'Morning',
            color: '#FFD54F',           // Yellow (sunrise)
            criteria: (hour) => hour < 12
        },
        afternoon: {
            label: 'Afternoon',
            color: '#F5A623',           // Carrot Orange (sunset)
            criteria: (hour) => hour >= 12 && hour < 17
        },
        evening: {
            label: 'Evening',
            color: '#37474F',           // Dark (night)
            criteria: (hour) => hour >= 17
        },
        allday: {
            label: 'All Day',
            color: '#66bb6a',           // Green
            criteria: (hour, isAllDay) => isAllDay
        }
    };

    /**
     * Evaluates all filter rules against an event and returns matches.
     * @param {Object} event - The event to evaluate
     * @returns {Object} - Object with filter IDs as keys, boolean values
     */
    function evaluateFilters(event) {
        const eventDate = new Date(event.startDate);
        const context = {
            now: new Date(),
            eventDate: eventDate,
            dayOfWeek: eventDate.getDay(),
            eventHour: eventDate.getHours(),
            tags: parseTags(event.tags),
            availability: getAvailability(event),
            isFree: event.isFree === 1 || event.minPrice === 0
        };

        const matches = {};
        for (const [id, rule] of Object.entries(FILTER_RULES)) {
            matches[id] = rule.criteria(event, context);
        }
        return matches;
    }

    /**
     * Gets filter rule by ID.
     * @param {string} filterId - The filter ID
     * @returns {Object|null} - The filter rule or null
     */
    function getFilterRule(filterId) {
        return FILTER_RULES[filterId] || null;
    }


// ═══════════════════════════════════════════════════════════════════════════
// SECTION 2: CSS OVERRIDE / THEME INTEGRATION                 [~19% of code]
// ═══════════════════════════════════════════════════════════════════════════
// Dependencies: None (pure CSS)
// Stability: HIGH | Break risk: LOW (visual only)
//
// This section contains CSS that styles the widget to match the ClubCalendar/WA theme.
// All class names use the .clubcal- prefix to avoid conflicts with host pages.
//
// WHAT YOU MIGHT NEED TO CHANGE:
// - Colors to match WA theme updates (search for #2c5aa0, #d4a800)
// - Font sizes if design changes
// - Layout spacing/margins
// ═══════════════════════════════════════════════════════════════════════════

    /**
     * Auto-detect theme colors from Wild Apricot page elements.
     * Looks for buttons, headers, links to extract the site's color scheme.
     *
     * @returns {Object} Detected theme colors (primary, accent, text, bg)
     */
    function detectWATheme() {
        const detected = {
            primary: null,
            accent: null,
            text: null,
            bg: null,
            linkColor: null
        };

        // Helper to get computed style safely
        function getStyle(el, prop) {
            if (!el) return null;
            try {
                const val = window.getComputedStyle(el).getPropertyValue(prop);
                // Filter out transparent/rgba(0,0,0,0) and default black
                if (!val || val === 'transparent' || val === 'rgba(0, 0, 0, 0)') return null;
                return val;
            } catch (e) {
                return null;
            }
        }

        // Helper to check if color is too light (close to white)
        function isTooLight(color) {
            if (!color) return true;
            // Parse rgb values
            const match = color.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
            if (!match) return false;
            const r = parseInt(match[1]), g = parseInt(match[2]), b = parseInt(match[3]);
            // Luminance check - if > 240 on all channels, too light
            return r > 240 && g > 240 && b > 240;
        }

        // Helper to check if color is too dark (close to black)
        function isTooDark(color) {
            if (!color) return true;
            const match = color.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
            if (!match) return false;
            const r = parseInt(match[1]), g = parseInt(match[2]), b = parseInt(match[3]);
            return r < 15 && g < 15 && b < 15;
        }

        // Find first matching element
        function findElement(selectors) {
            for (const sel of selectors) {
                try {
                    const el = document.querySelector(sel);
                    if (el) return el;
                } catch (e) {}
            }
            return null;
        }

        // WA button selectors (primary color source)
        const buttonSelectors = [
            '.wa-button',
            'button[type="submit"]',
            '.btn-primary',
            'input[type="submit"]',
            '.primaryButton',
            '#lnkSignIn',
            '.wa-page-container button',
            '.button'
        ];

        // Header/nav selectors (primary or accent color)
        const headerSelectors = [
            '.wa-page-header',
            '#header',
            '.header',
            'nav',
            '.navigation',
            '.wa-menu',
            '.headerWrapper'
        ];

        // Link selectors (accent color)
        const linkSelectors = [
            'a:not([class*="clubcal"])',
            '.wa-link',
            'nav a',
            '.menu a'
        ];

        // Detect primary color from buttons
        const button = findElement(buttonSelectors);
        if (button) {
            const bg = getStyle(button, 'background-color');
            if (bg && !isTooLight(bg) && !isTooDark(bg)) {
                detected.primary = bg;
            }
        }

        // If no button color, try header background
        if (!detected.primary) {
            const header = findElement(headerSelectors);
            if (header) {
                const bg = getStyle(header, 'background-color');
                if (bg && !isTooLight(bg) && !isTooDark(bg)) {
                    detected.primary = bg;
                }
            }
        }

        // Detect accent/link color
        const link = findElement(linkSelectors);
        if (link) {
            const color = getStyle(link, 'color');
            if (color && !isTooDark(color)) {
                detected.linkColor = color;
                // Use link color as accent if it's different from primary
                if (color !== detected.primary) {
                    detected.accent = color;
                }
            }
        }

        // Detect text color from body
        const body = document.body;
        if (body) {
            const textColor = getStyle(body, 'color');
            if (textColor && !isTooLight(textColor)) {
                detected.text = textColor;
            }
            const bgColor = getStyle(body, 'background-color');
            if (bgColor) {
                detected.bg = bgColor;
            }
        }

        return detected;
    }

    /**
     * Apply detected WA theme colors as CSS variable overrides.
     * Only applies colors that were successfully detected.
     * User's explicit CONFIG colors take precedence.
     */
    function applyDetectedTheme() {
        // Skip if auto-detection is disabled
        if (CONFIG.disableThemeDetection) {
            return;
        }

        // Skip if already applied
        if (document.getElementById('clubcalendar-theme-detected')) {
            return;
        }

        const detected = detectWATheme();
        const overrides = [];

        // Only use detected colors if CONFIG doesn't specify them
        // CONFIG colors (from builder) take precedence
        if (detected.primary && !CONFIG.primaryColor) {
            overrides.push(`--clubcal-primary: ${detected.primary};`);
            // Generate darker variant for hover
            overrides.push(`--clubcal-primary-hover: ${detected.primary};`);
        }

        if (detected.accent && !CONFIG.accentColor) {
            overrides.push(`--clubcal-accent: ${detected.accent};`);
        } else if (detected.linkColor && !CONFIG.accentColor) {
            overrides.push(`--clubcal-accent: ${detected.linkColor};`);
        }

        if (detected.text) {
            overrides.push(`--clubcal-text: ${detected.text};`);
        }

        // Only inject if we detected something
        if (overrides.length > 0) {
            const style = document.createElement('style');
            style.id = 'clubcalendar-theme-detected';
            style.textContent = `
/* Auto-detected WA theme colors */
:root {
    ${overrides.join('\n    ')}
}`;
            document.head.appendChild(style);
            console.log('[ClubCalendar] Auto-detected WA theme:', detected);
        }
    }

    /**
     * Injects widget CSS styles into the document.
     * Uses .clubcal-* scoped class names to avoid conflicts.
     *
     * COLOR MAPPING TO WA THEME:
     *   #2c5aa0 - WA primary blue (header, links, focus states)
     *   #d4a800 - WA secondary gold (accents, highlights)
     *   #f8f9fa - Light gray background (filter bar)
     *   #333333 - Primary text color
     *   #666666 - Secondary/muted text
     *
     * @returns {void}
     */
    function injectStyles() {
        // Skip if already injected
        if (document.getElementById('clubcalendar-styles')) {
            return;
        }

        const css = `
/* ═══════════════════════════════════════════════════════════════════════════
   ClubCalendar Widget Styles

   These styles override/extend FullCalendar styles to match WA theme.
   All colors use CSS custom properties for easy theming via WA Custom CSS.
   ═══════════════════════════════════════════════════════════════════════════ */

/* --- Theme Color Variables --- */
/* Override these in WA's Custom CSS to match your theme */
:root {
    /* Primary brand colors */
    --clubcal-primary: #2c5aa0;
    --clubcal-primary-dark: #1e3d6b;
    --clubcal-primary-hover: #234a80;
    --clubcal-primary-light: #6c9bd1;
    --clubcal-accent: #d4a800;

    /* Text colors */
    --clubcal-text: #333333;
    --clubcal-text-muted: #666666;
    --clubcal-text-light: #888888;

    /* Background colors */
    --clubcal-bg-light: #f8f9fa;
    --clubcal-bg-hover: #f5f5f5;
    --clubcal-bg-active: #f0f0f0;

    /* Border colors */
    --clubcal-border: #dddddd;
    --clubcal-border-light: #eeeeee;
    --clubcal-border-dark: #bbbbbb;

    /* Status colors */
    --clubcal-success: #4caf50;
    --clubcal-success-dark: #2e7d32;
    --clubcal-success-bg: #e8f5e9;
    --clubcal-warning: #ff9800;
    --clubcal-warning-dark: #e65100;
    --clubcal-warning-bg: #fff3e0;
    --clubcal-error: #dc3545;
    --clubcal-error-dark: #c82333;
    --clubcal-error-bg: #ffebee;
    --clubcal-info: #2196f3;
    --clubcal-info-dark: #1565c0;
    --clubcal-info-bg: #e3f2fd;

    /* Time of day colors (used by filter dots) */
    --clubcal-morning: #FFD54F;
    --clubcal-afternoon: #F5A623;
    --clubcal-evening: #37474F;
    --clubcal-allday: #66bb6a;

    /* Filter dot colors */
    --clubcal-dot-justopened: #e91e63;
    --clubcal-dot-openingsoon: #009688;
    --clubcal-dot-openings: #4caf50;
    --clubcal-dot-newbie: #00bcd4;
    --clubcal-dot-public: #8bc34a;
    --clubcal-dot-weekend: #9c27b0;
    --clubcal-dot-free: #ffc107;
    --clubcal-dot-afterhours: #5c6bc0;
    --clubcal-dot-myevents: #e91e63;  /* Pink for user's registered events */

    /* Availability colors */
    --clubcal-avail-public: #4caf50;
    --clubcal-avail-available: #2196f3;
    --clubcal-avail-limited: #ff9800;
    --clubcal-avail-waitlist: #f44336;

    --clubcal-avail-unavailable: #9e9e9e;
}

/* --- Base Container --- */
.clubcalendar-widget {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    color: var(--clubcal-text);
    line-height: 1.5;
    width: 100%;
    box-sizing: border-box;
}

/* --- Header Styling --- */
.clubcalendar-header {
    padding: 15px 0;
    margin-bottom: 15px;
    border-bottom: 2px solid var(--clubcal-primary);
}
.clubcalendar-header h2 {
    margin: 0;
    color: var(--clubcal-primary);
    font-size: 24px;
    font-weight: 600;
}
.clubcalendar-header p {
    margin: 5px 0 0;
    color: var(--clubcal-text-muted);
    font-size: 14px;
}

/* --- Help Icon and Tooltip --- */
.clubcal-header-row {
    display: flex;
    align-items: center;
    gap: 10px;
}
.clubcal-help-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: #e8f0fe;
    color: var(--clubcal-primary);
    font-size: 13px;
    font-weight: 700;
    cursor: help;
    position: relative;
    border: 1px solid var(--clubcal-primary);
    transition: all 0.2s ease;
}
.clubcal-help-icon:hover {
    background: var(--clubcal-primary);
    color: white;
}
.clubcal-help-tooltip {
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    margin-top: 10px;
    width: 320px;
    background: white;
    border: 1px solid var(--clubcal-border);
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    padding: 15px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s ease;
    z-index: 1000;
    text-align: left;
    font-weight: normal;
}
.clubcal-help-tooltip::before {
    content: '';
    position: absolute;
    top: -8px;
    left: 50%;
    transform: translateX(-50%);
    border-left: 8px solid transparent;
    border-right: 8px solid transparent;
    border-bottom: 8px solid #ddd;
}
.clubcal-help-tooltip::after {
    content: '';
    position: absolute;
    top: -6px;
    left: 50%;
    transform: translateX(-50%);
    border-left: 7px solid transparent;
    border-right: 7px solid transparent;
    border-bottom: 7px solid white;
}
.clubcal-help-icon:hover .clubcal-help-tooltip {
    opacity: 1;
    visibility: visible;
}
.clubcal-help-tooltip h4 {
    margin: 0 0 10px 0;
    font-size: 14px;
    color: var(--clubcal-primary);
    font-weight: 600;
}
.clubcal-help-tooltip p {
    margin: 0 0 8px 0;
    font-size: 12px;
    color: var(--clubcal-text-muted);
    line-height: 1.5;
}
.clubcal-help-section {
    margin-bottom: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid #eee;
}
.clubcal-help-section:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
}
.clubcal-help-section strong {
    display: block;
    font-size: 11px;
    color: var(--clubcal-text);
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.clubcal-help-dots {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 6px;
}
.clubcal-help-dot-item {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    color: #555;
}
.clubcal-help-dot-item .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

/* --- Filter Bar --- */
.clubcal-filter-bar {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: flex-end;
    margin-bottom: 15px;
    padding: 15px;
    background: var(--clubcal-bg-light);
    border-radius: 8px;
}
.clubcal-filter-group {
    display: flex;
    flex-direction: column;
    min-width: 150px;
}
.clubcal-filter-group label {
    font-size: 11px;
    color: var(--clubcal-text-muted);
    margin-bottom: 4px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.clubcal-filter-group select {
    padding: 8px 10px;
    border: 1px solid var(--clubcal-border);
    border-radius: 4px;
    font-size: 14px;
    background: white;
}
.clubcal-filter-group select:focus {
    outline: none;
    border-color: var(--clubcal-primary);
    box-shadow: 0 0 0 2px rgba(44, 90, 160, 0.2);
}

/* --- Quick Filters --- */
.clubcal-quick-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding-top: 12px;
    border-top: 1px solid #e0e0e0;
    margin-top: 12px;
}
.clubcal-quick-filter {
    padding: 6px 14px;
    background: #fff;
    border: 1px solid var(--clubcal-border);
    border-radius: 20px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
}
.clubcal-quick-filter:hover {
    background: var(--clubcal-primary);
    color: white;
    border-color: var(--clubcal-primary);
}
.clubcal-quick-filter.active {
    background: var(--clubcal-primary);
    color: white;
    border-color: var(--clubcal-primary);
}

/* --- Clear Button --- */
.clubcal-btn-clear {
    padding: 8px 16px;
    background: white;
    border: 1px solid var(--clubcal-border);
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    transition: background-color 0.2s;
}
.clubcal-btn-clear:hover {
    background: var(--clubcal-bg-active);
}
.clubcal-clear-btn {
    padding: 8px 16px;
    background: #dc3545;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    color: white;
    transition: all 0.2s;
    margin-left: auto;
}
.clubcal-clear-btn:hover {
    background: #c82333;
}

/* --- View Toggle --- */
.clubcal-view-toggle {
    display: flex;
    gap: 4px;
    background: var(--clubcal-primary);
    padding: 4px;
    border-radius: 6px;
}
.clubcal-view-btn {
    padding: 6px 14px;
    border: none;
    background: transparent;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    color: rgba(255,255,255,0.8);
    transition: all 0.2s;
}
.clubcal-view-btn:hover {
    background: rgba(255,255,255,0.15);
    color: white;
}
.clubcal-view-btn.active {
    background: white;
    color: var(--clubcal-primary);
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

/* --- Results Count --- */
.clubcal-results-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    font-size: 14px;
    color: var(--clubcal-text-muted);
}
.clubcal-results-bar strong {
    color: var(--clubcal-text);
}

/* --- Calendar Container --- */
.clubcalendar-content {
    min-height: 400px;
    width: 100%;
}

/* --- FullCalendar Overrides --- */
.clubcalendar-widget .fc {
    font-family: inherit;
    width: 100% !important;
}
.clubcalendar-widget .fc-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.clubcalendar-widget .fc-toolbar-chunk:nth-child(2) {
    flex: 1;
    text-align: center;
}
.clubcalendar-widget .fc-toolbar-title {
    font-size: 1.2em;
    color: var(--clubcal-text);
    display: inline;
}
.clubcalendar-widget .fc-button-primary {
    background-color: var(--clubcal-primary);
    border-color: var(--clubcal-primary);
}
.clubcalendar-widget .fc-button-primary:hover {
    background-color: #234a80;
    border-color: #234a80;
}
.clubcalendar-widget .fc-button-primary:disabled {
    background-color: #6c9bd1;
    border-color: #6c9bd1;
}
.clubcalendar-widget .fc-button-primary:not(:disabled).fc-button-active {
    background-color: #1e3d6b;
    border-color: #1e3d6b;
}
.clubcalendar-widget .fc-daygrid-day-number {
    color: var(--clubcal-text);
}
.clubcalendar-widget .fc-col-header-cell-cushion {
    color: var(--clubcal-text-muted);
}

/* --- Event Styling --- */
.clubcalendar-widget .fc-event {
    border-radius: 3px;
    font-size: 12px;
    cursor: pointer;
}
.clubcalendar-widget .fc-event:hover {
    opacity: 0.9;
}

/* List view specific styles */
.clubcalendar-widget .fc-list-event:hover td {
    background-color: #f5f5f5 !important;
}
.clubcalendar-widget .fc-list-event-time {
    white-space: nowrap;
}
.clubcalendar-widget .fc-list-event-title {
    cursor: pointer;
}
.clubcalendar-widget .fc-list-event .clubcal-event-content {
    display: inline-flex;
    flex-direction: row;
    align-items: center;
    gap: 8px;
}
.clubcalendar-widget .fc-list-event .clubcal-event-time-row {
    display: none; /* Time is shown in separate column in list view */
}
.clubcalendar-widget .fc-list-event .clubcal-event-title-row {
    display: inline;
}
.clubcalendar-widget .fc-list-day-cushion {
    background: var(--clubcal-bg-light);
}
.clubcalendar-widget .fc-list-event-graphic {
    display: none; /* Hide default dot */
}

/* List view badges */
.clubcal-event-content-list {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
}
.clubcal-badges-container {
    display: inline-flex;
    gap: 6px;
    flex-wrap: wrap;
}
.clubcal-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
    white-space: nowrap;
}
.clubcal-badge.weekend {
    background: #f3e5f5;
    color: #7b1fa2;
}
.clubcal-badge.openings {
    background: var(--clubcal-success-bg);
    color: var(--clubcal-success-dark);
}
.clubcal-badge.free {
    background: #fff8e1;
    color: #f57f17;
}
.clubcal-badge.afterhours {
    background: #e8eaf6;
    color: #3949ab;
}
.clubcal-badge.newbie {
    background: #e0f7fa;
    color: #00838f;
}
.clubcal-badge.justopened {
    background: #fce4ec;
    color: #c2185b;
}
.clubcal-badge.openingsoon {
    background: #e0f2f1;
    color: #00796b;
}

/* Active filters display */
.clubcal-active-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 8px 0;
    font-size: 13px;
    color: var(--clubcal-text-muted);
    min-height: 20px;
}
.clubcal-active-filters:empty {
    display: none;
}
.clubcal-active-filter-tag {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: var(--clubcal-info-bg);
    color: var(--clubcal-info-dark);
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
}
.clubcal-active-filter-label {
    font-weight: 600;
}
.clubcal-filter-count {
    background: var(--clubcal-primary);
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: 600;
}
.clubcalendar-widget .fc-daygrid-event {
    padding: 2px 4px;
}

/* ═══════════════════════════════════════════════════════════════════════════
   EVENT TIME-OF-DAY COLORS
   Morning (before 12pm) = Yellow/Sunrise
   Afternoon (12pm-5pm) = Orange/Sunset
   Evening (after 5pm) = Dark/Night
   All-day events = Green
   ═══════════════════════════════════════════════════════════════════════════ */

/* Morning events - Yellow (sunrise) */
.clubcal-event-morning {
    --fc-event-bg-color: #FFD54F;
    --fc-event-border-color: #F0A020;
    --fc-event-text-color: #000;
    background-color: #FFD54F;
    border-color: #F0A020;
    color: #000;
}
.clubcal-event-morning .fc-event-main {
    color: #000;
}

/* Afternoon events - Carrot Orange (sunset) */
.clubcal-event-afternoon {
    --fc-event-bg-color: #F5A623;
    --fc-event-border-color: #D4881A;
    --fc-event-text-color: #000;
    background-color: #F5A623;
    border-color: #D4881A;
    color: #000;
}
.clubcal-event-afternoon .fc-event-main {
    color: #000;
}

/* Evening events - Dark (night) */
.clubcal-event-evening {
    --fc-event-bg-color: #37474F;
    --fc-event-border-color: #263238;
    --fc-event-text-color: #fff;
    background-color: #37474F;
    border-color: #263238;
    color: #fff;
}
.clubcal-event-evening .fc-event-main {
    color: #fff;
}

/* All-day events - Green */
.clubcal-event-allday {
    --fc-event-bg-color: #66bb6a;
    --fc-event-border-color: #43a047;
    --fc-event-text-color: #000;
    background-color: #66bb6a;
    border-color: #43a047;
    color: #000;
}
.clubcal-event-allday .fc-event-main {
    color: #000;
}

/* FullCalendar dot-event overrides - ensure our colors show through */
.fc-daygrid-dot-event.clubcal-event-morning,
.fc-daygrid-dot-event.clubcal-event-morning:hover {
    background-color: #FFD54F !important;
}
.fc-daygrid-dot-event.clubcal-event-afternoon,
.fc-daygrid-dot-event.clubcal-event-afternoon:hover {
    background-color: #F5A623 !important;
}
.fc-daygrid-dot-event.clubcal-event-evening,
.fc-daygrid-dot-event.clubcal-event-evening:hover {
    background-color: #37474F !important;
    color: #fff !important;
}
.fc-daygrid-dot-event.clubcal-event-allday,
.fc-daygrid-dot-event.clubcal-event-allday:hover {
    background-color: #66bb6a !important;
}

/* Also target fc-event directly with high specificity */
a.fc-event.clubcal-event-morning {
    background-color: #FFD54F !important;
    border-color: #F0A020 !important;
}
a.fc-event.clubcal-event-afternoon,
a.fc-event.clubcal-event-afternoon:hover,
.fc-event.clubcal-event-afternoon,
.clubcal-event-afternoon.fc-daygrid-event,
.clubcal-event-afternoon.fc-daygrid-dot-event {
    background-color: #F5A623 !important;
    background: #F5A623 !important;
    border-color: #D4881A !important;
}
.clubcal-event-afternoon::before,
.clubcal-event-afternoon::after,
.clubcal-event-afternoon .fc-daygrid-event-dot,
.clubcal-event-afternoon .fc-event-main::before,
.clubcal-event-afternoon .fc-event-main::after {
    background-color: #F5A623 !important;
    background: #F5A623 !important;
    border-color: #D4881A !important;
}

/* Nuclear option: force all afternoon event elements */
.clubcal-event-afternoon,
.clubcal-event-afternoon *,
.clubcal-event-afternoon::before,
.clubcal-event-afternoon::after,
.clubcal-event-afternoon *::before,
.clubcal-event-afternoon *::after {
    background-color: #F5A623 !important;
    background: #F5A623 !important;
    filter: none !important;
    opacity: 1 !important;
    mix-blend-mode: normal !important;
}
a.fc-event.clubcal-event-evening {
    background-color: #37474F !important;
    border-color: #263238 !important;
    color: #fff !important;
}
a.fc-event.clubcal-event-allday {
    background-color: #66bb6a !important;
    border-color: #43a047 !important;
}

/* Time filter buttons */
.clubcal-time-filters {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}
.clubcal-time-filter-btn {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 5px 10px;
    border: 1px solid var(--clubcal-border);
    border-radius: 15px;
    background: white;
    font-size: 12px;
    color: var(--clubcal-text-muted);
    cursor: pointer;
    transition: all 0.2s;
}
.clubcal-time-filter-btn:hover {
    background: var(--clubcal-bg-hover);
    border-color: #bbb;
}
.clubcal-time-filter-btn.active {
    background: var(--clubcal-info-bg);
    border-color: #2196f3;
    color: var(--clubcal-info-dark);
}
.clubcal-time-filter-dot {
    width: 10px;
    height: 10px;
    border-radius: 3px;
}
.clubcal-time-filter-dot.morning { background: var(--clubcal-morning); }
.clubcal-time-filter-dot.afternoon { background: var(--clubcal-afternoon); }
.clubcal-time-filter-dot.evening { background: var(--clubcal-evening); }
.clubcal-time-filter-dot.allday { background: var(--clubcal-allday); }

/* Availability filter buttons */
.clubcal-avail-filters {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-top: 8px;
}
.clubcal-avail-filter-btn {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    border: 1px solid var(--clubcal-border);
    border-radius: 12px;
    background: white;
    font-size: 11px;
    color: var(--clubcal-text-muted);
    cursor: pointer;
    transition: all 0.2s;
}
.clubcal-avail-filter-btn:hover {
    background: var(--clubcal-bg-hover);
    border-color: #bbb;
}
.clubcal-avail-filter-btn.active {
    background: var(--clubcal-success-bg);
    border-color: #4caf50;
    color: var(--clubcal-success-dark);
}

/* Availability indicator dots */
.clubcal-avail-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
    flex-shrink: 0;
}
.clubcal-avail-dot.public { background: var(--clubcal-avail-public); }
.clubcal-avail-dot.available { background: var(--clubcal-avail-available); }
.clubcal-avail-dot.limited { background: var(--clubcal-avail-limited); }
.clubcal-avail-dot.waitlist { background: var(--clubcal-avail-waitlist); }
.clubcal-avail-dot.unavailable { background: var(--clubcal-avail-unavailable); }

/* Filter button dots - each filter type has a unique color */
.clubcal-filter-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
    flex-shrink: 0;
}
.clubcal-filter-dot.weekend { background: var(--clubcal-dot-weekend); }
.clubcal-filter-dot.openings { background: var(--clubcal-dot-openings); }
.clubcal-filter-dot.free { background: var(--clubcal-dot-free); }
.clubcal-filter-dot.afterhours { background: var(--clubcal-dot-afterhours); }
.clubcal-filter-dot.newbie { background: var(--clubcal-dot-newbie); }
.clubcal-filter-dot.public { background: var(--clubcal-dot-public); }
.clubcal-filter-dot.justopened { background: var(--clubcal-dot-justopened); }
.clubcal-filter-dot.openingsoon { background: var(--clubcal-dot-openingsoon); }
.clubcal-filter-dot.myevents { background: var(--clubcal-dot-myevents); }

/* Registered event indicator - checkmark badge */
.clubcal-registered-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: var(--clubcal-dot-myevents);
    color: white;
    font-size: 10px;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    margin-left: 4px;
    font-weight: bold;
}
.clubcal-badge.registered {
    background: var(--clubcal-dot-myevents);
    color: white;
}

/* Event display - custom content with time+dots on first line */
.clubcalendar-widget .fc-daygrid-event {
    white-space: normal !important;
    padding: 2px 4px !important;
    margin-right: 1px !important;
}
.clubcal-event-content {
    display: flex;
    flex-direction: column;
}
.clubcal-event-time-row {
    display: flex;
    align-items: center;
    font-size: 10px;
    font-weight: 600;
    opacity: 0.9;
    white-space: nowrap;
}
.clubcal-event-title-row {
    font-size: 11px;
    line-height: 1.2;
    word-wrap: break-word;
}
.clubcalendar-widget .fc-event-main {
    display: block !important;
    padding-right: 1px;
}
.clubcalendar-widget .fc-daygrid-event-dot {
    display: none !important;
}

/* Allow day cells to expand */
.clubcalendar-widget .fc-daygrid-day-frame {
    min-height: auto !important;
}
.clubcalendar-widget .fc-daygrid-day-events {
    min-height: auto !important;
}

/* Filter row - allows wrapping to multiple lines */
.clubcal-filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    align-items: center;
    margin-bottom: 12px;
}
.clubcal-filter-row-label {
    font-size: 11px;
    color: #888;
    font-weight: 500;
    margin-right: 4px;
}

/* Quick action buttons - flexible sizing */
.clubcal-action-btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 6px 10px;
    border: 1px solid var(--clubcal-border);
    border-radius: 14px;
    background: white;
    font-size: 12px;
    color: #555;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
}
.clubcal-action-btn:hover {
    background: var(--clubcal-bg-active);
    border-color: #bbb;
}
.clubcal-action-btn.active {
    background: var(--clubcal-primary);
    border-color: var(--clubcal-primary);
    color: white;
}
.clubcal-action-btn.active .clubcal-filter-dot,
.clubcal-action-btn.active .clubcal-time-filter-dot,
.clubcal-action-btn.active .clubcal-avail-dot {
    box-shadow: 0 0 0 1px white;
}

/* Past events checkbox */
.clubcal-past-toggle {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--clubcal-text-muted);
    margin-left: auto;
}
.clubcal-past-toggle input {
    width: 14px;
    height: 14px;
    cursor: pointer;
}

/* Cost filter */
.clubcal-cost-filter {
    padding: 5px 10px;
    border: 1px solid var(--clubcal-border);
    border-radius: 4px;
    font-size: 12px;
    background: white;
}

/* --- Event Popup --- */
.clubcal-event-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    max-width: 450px;
    width: 90%;
    z-index: 10000;
    overflow: hidden;
}
.clubcal-event-popup-header {
    background: linear-gradient(135deg, var(--clubcal-primary) 0%, var(--clubcal-primary-dark) 100%);
    color: white;
    padding: 20px;
}
.clubcal-event-popup-header h3 {
    margin: 0 0 8px;
    font-size: 18px;
    color: white !important;
}
.clubcal-event-popup-category {
    display: inline-block;
    padding: 3px 10px;
    background: rgba(255,255,255,0.2);
    border-radius: 12px;
    font-size: 11px;
    text-transform: uppercase;
}
.clubcal-event-popup-body {
    padding: 20px;
}
.clubcal-event-popup-meta {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 15px;
}
.clubcal-event-popup-meta-item {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
    color: var(--clubcal-text-muted);
}
.clubcal-event-popup-meta-item strong {
    color: var(--clubcal-text);
}
.clubcal-event-popup-description {
    margin: 15px 0;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    max-height: 200px;
    overflow-y: auto;
    font-size: 14px;
    line-height: 1.5;
    color: var(--clubcal-text);
}
.clubcal-event-popup-description p {
    margin: 0 0 10px;
}
.clubcal-event-popup-description p:last-child {
    margin-bottom: 0;
}
.clubcal-hover-popup {
    max-width: 400px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.25);
}
.clubcal-event-popup-actions {
    display: flex;
    gap: 10px;
    padding-top: 15px;
    border-top: 1px solid #eee;
}
.clubcal-event-popup-actions .clubcal-btn {
    flex: 1;
    padding: 10px 16px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    text-align: center;
    text-decoration: none;
}
.clubcal-btn-primary {
    background: var(--clubcal-primary);
    color: white;
}
.clubcal-btn-primary:hover {
    background: #234a80;
}
.clubcal-btn-secondary {
    background: var(--clubcal-bg-active);
    color: var(--clubcal-text);
}
.clubcal-btn-secondary:hover {
    background: #e0e0e0;
}
.clubcal-btn-calendar {
    background: var(--clubcal-success);
    color: white;
    text-decoration: none;
}
.clubcal-btn-calendar:hover {
    background: var(--clubcal-success-dark);
}

/* --- Add to Calendar Icons --- */
.clubcal-calendar-icons {
    display: flex;
    align-items: center;
    gap: 6px;
}
.clubcal-calendar-label {
    font-size: 12px;
    color: var(--clubcal-text-muted);
    margin-right: 2px;
}
.clubcal-cal-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 8px;
    text-decoration: none;
    cursor: pointer;
    transition: transform 0.15s, box-shadow 0.15s;
    border: none;
    padding: 0;
}
.clubcal-cal-btn svg {
    display: block;
}
.clubcal-cal-btn:hover {
    transform: scale(1.15);
    box-shadow: 0 3px 10px rgba(0,0,0,0.25);
}
.clubcal-cal-google { background: #4285f4; }
.clubcal-cal-outlook { background: #0078d4; }
.clubcal-cal-yahoo { background: #6001d2; }
.clubcal-cal-apple { background: #333; }

/* --- Popup text links (not buttons) should be underlined for accessibility --- */
.clubcal-event-popup-body a:not(.clubcal-btn) {
    text-decoration: underline;
    color: var(--clubcal-primary);
}
.clubcal-event-popup-body a:not(.clubcal-btn):hover {
    text-decoration: underline;
    color: #1e3d6b;
}

/* --- Expandable Sections (Accordion) --- */
.clubcal-popup-sections {
    border-top: 1px solid #eee;
    margin-top: 15px;
}
.clubcal-popup-section {
    border-bottom: 1px solid #eee;
}
.clubcal-popup-section:last-child {
    border-bottom: none;
}
.clubcal-popup-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 0;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    color: var(--clubcal-primary);
    transition: color 0.2s;
}
.clubcal-popup-section-header:hover {
    color: #1e3d6b;
}
.clubcal-popup-section-header .clubcal-section-icon {
    margin-right: 8px;
}
.clubcal-popup-section-header .clubcal-section-arrow {
    transition: transform 0.3s;
    font-size: 12px;
}
.clubcal-popup-section.expanded .clubcal-section-arrow {
    transform: rotate(180deg);
}
.clubcal-popup-section-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
}
.clubcal-popup-section.expanded .clubcal-popup-section-content {
    max-height: 300px;
    overflow-y: auto;
}
.clubcal-popup-section-inner {
    padding: 0 0 15px;
}

/* --- Registrants List --- */
.clubcal-registrants-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
}
.clubcal-registrant {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    background: var(--clubcal-bg-light);
    border-radius: 6px;
    font-size: 13px;
}
.clubcal-registrant-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: var(--clubcal-primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
}
.clubcal-registrant-name {
    flex: 1;
    color: var(--clubcal-text);
}
.clubcal-registrant-name a {
    color: var(--clubcal-primary);
    text-decoration: none;
}
.clubcal-registrant-name a:hover {
    text-decoration: underline;
}
.clubcal-registrants-loading,
.clubcal-registrants-empty {
    padding: 15px;
    text-align: center;
    color: var(--clubcal-text-muted);
    font-size: 13px;
}
.clubcal-registrants-count {
    font-size: 12px;
    color: var(--clubcal-text-muted);
    font-weight: normal;
    margin-left: 8px;
}

/* --- Photo Gallery Link --- */
.clubcal-gallery-link {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 15px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 8px;
    color: white;
    text-decoration: none;
    font-size: 14px;
    transition: transform 0.2s, box-shadow 0.2s;
}
.clubcal-gallery-link:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}
.clubcal-gallery-link .clubcal-gallery-count {
    background: rgba(255,255,255,0.2);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 12px;
}

/* --- Popup Overlay --- */
.clubcal-popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
}

/* --- Hover Tooltip (Event Preview) --- */
.clubcal-hover-tooltip,
.clubcal-event-popup {
    position: fixed;
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.2);
    max-width: 450px;
    min-width: 320px;
    z-index: 10001;
    pointer-events: auto;
    font-family: inherit;
    overflow: hidden;
    max-height: 90vh;
    overflow-y: auto;
}
.clubcal-hover-tooltip-header {
    background: linear-gradient(135deg, var(--clubcal-primary) 0%, var(--clubcal-primary-dark) 100%);
    color: white;
    padding: 18px 20px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 12px;
}
.clubcal-hover-tooltip-title {
    font-weight: 600;
    font-size: 20px;
    color: white;
    flex: 1;
    line-height: 1.3;
}
.clubcal-tooltip-close {
    background: none;
    border: none;
    color: rgba(255,255,255,0.8);
    font-size: 22px;
    line-height: 1;
    cursor: pointer;
    padding: 0;
    margin: -4px -4px 0 0;
    transition: color 0.15s;
}
.clubcal-tooltip-close:hover {
    color: white;
}
.clubcal-hover-tooltip-body {
    padding: 18px 20px;
}
.clubcal-hover-tooltip-meta {
    display: flex;
    flex-direction: column;
    gap: 8px;
    font-size: 16px;
    color: #555;
}
.clubcal-hover-tooltip-meta div {
    display: flex;
    align-items: center;
    gap: 6px;
}
.clubcal-hover-tooltip-desc {
    font-size: 15px;
    color: #444;
    line-height: 1.6;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #eee;
    max-height: 180px;
    overflow-y: auto;
    white-space: pre-wrap;
}
.clubcal-hover-tooltip-action {
    margin-top: 14px;
    padding-top: 14px;
    border-top: 1px solid #eee;
}
.clubcal-tooltip-btn {
    display: block;
    width: 100%;
    padding: 14px 20px;
    background: var(--clubcal-accent);
    color: #000;
    text-align: center;
    text-decoration: none;
    font-weight: 600;
    font-size: 16px;
    border-radius: 8px;
    transition: background 0.2s;
}
.clubcal-tooltip-btn:hover {
    background: #c49700;
    color: #000;
}
.clubcal-tooltip-btn-primary {
    background: var(--clubcal-primary);
    color: white;
}
.clubcal-tooltip-btn-primary:hover {
    background: var(--clubcal-primary-dark);
    color: white;
}

/* --- Loading State --- */
.clubcal-loading {
    text-align: center;
    padding: 40px;
    color: #888;
}
.clubcal-error {
    text-align: center;
    padding: 40px;
    color: #c00;
    background: #fee;
    border-radius: 8px;
}

/* --- Tabs --- */
.clubcal-tabs {
    display: flex;
    gap: 0;
    margin-bottom: 0;
}
.clubcal-tab-btn {
    flex: 1;
    padding: 14px 20px;
    font-size: 15px;
    font-weight: 600;
    border: none;
    background: #e0e0e0;
    color: var(--clubcal-text-muted);
    cursor: pointer;
    transition: all 0.2s;
    border-radius: 8px 8px 0 0;
}
.clubcal-tab-btn:hover {
    background: #d0d0d0;
}
.clubcal-tab-btn.active {
    background: white;
    color: var(--clubcal-primary);
}
.clubcal-tab-content {
    display: none;
    background: white;
    padding: 20px;
    border-radius: 0 0 8px 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.clubcal-tab-content.active {
    display: block;
}


/* --- Event List View --- */
.clubcal-event-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}
.clubcal-event-card {
    display: flex;
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
}
.clubcal-event-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.clubcal-event-card.registered {
    border-left: 4px solid #2c5aa0;
}
.clubcal-event-card.waitlist {
    border-left: 4px solid #ff9800;
}
.clubcal-event-card-date {
    background: linear-gradient(135deg, var(--clubcal-primary) 0%, var(--clubcal-primary-dark) 100%);
    color: white;
    padding: 16px;
    min-width: 80px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}
.clubcal-event-card-date .month {
    font-size: 12px;
    text-transform: uppercase;
    opacity: 0.9;
}
.clubcal-event-card-date .day {
    font-size: 28px;
    font-weight: 700;
    line-height: 1;
}
.clubcal-event-card-date .weekday {
    font-size: 11px;
    opacity: 0.8;
    margin-top: 4px;
}
.clubcal-event-card-content {
    flex: 1;
    padding: 16px;
}
.clubcal-event-card-category {
    display: inline-block;
    padding: 4px 10px;
    background: var(--clubcal-bg-active);
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    color: var(--clubcal-text-muted);
    margin-bottom: 8px;
    text-transform: uppercase;
}
.clubcal-event-card-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--clubcal-text);
    margin-bottom: 6px;
}
.clubcal-event-card-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    font-size: 13px;
    color: var(--clubcal-text-muted);
}
.clubcal-event-card-status {
    padding: 16px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: 90px;
    border-left: 1px solid #eee;
}
.clubcal-status-badge {
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 12px;
    font-weight: 600;
}
.clubcal-status-badge.confirmed {
    background: var(--clubcal-info-bg);
    color: var(--clubcal-info-dark);
}
.clubcal-status-badge.waitlist {
    background: #fff3e0;
    color: #e65100;
}
.clubcal-status-badge.past {
    background: #f3e5f5;
    color: #7b1fa2;
}

/* --- Responsive Layout - Tablet --- */
@media (max-width: 900px) {
    .clubcal-filter-bar {
        flex-wrap: wrap;
        gap: 10px;
    }
    .clubcal-filter-group {
        min-width: 120px;
    }
    .clubcal-action-btn {
        padding: 5px 8px;
        font-size: 11px;
    }
    .clubcalendar-widget .fc-toolbar {
        flex-wrap: wrap;
        gap: 8px;
    }
    .clubcalendar-widget .fc-toolbar-chunk:nth-child(2) {
        order: -1;
        width: 100%;
        margin-bottom: 8px;
    }
}

/* --- Responsive Layout - Mobile --- */
@media (max-width: 600px) {
    .clubcal-filter-bar {
        flex-direction: column;
        align-items: stretch;
    }
    .clubcal-filter-group {
        width: 100%;
        min-width: unset !important;
    }
    .clubcal-filter-group select {
        width: 100%;
    }
    .clubcal-view-toggle {
        width: 100%;
        justify-content: center;
    }
    .clubcal-view-btn {
        flex: 1;
    }
    .clubcal-clear-btn {
        width: 100%;
        margin-left: 0;
        margin-top: 8px;
    }
    .clubcal-filter-row {
        justify-content: center;
    }
    .clubcal-action-btn {
        padding: 6px 10px;
        font-size: 11px;
    }
    .clubcal-event-popup {
        width: 95%;
        max-height: 90vh;
        overflow-y: auto;
    }
    .clubcal-event-card {
        flex-direction: column;
    }
    .clubcal-event-card-date {
        flex-direction: row;
        gap: 10px;
        padding: 12px;
    }
    .clubcal-event-card-status {
        border-left: none;
        border-top: 1px solid #eee;
        flex-direction: row;
        gap: 10px;
    }
    .clubcalendar-widget .fc-toolbar {
        flex-direction: column;
        gap: 10px;
    }
    .clubcalendar-widget .fc-toolbar-chunk {
        width: 100%;
        display: flex;
        justify-content: center;
    }
    .clubcalendar-widget .fc-toolbar-chunk:nth-child(2) {
        order: -1;
    }
    .clubcal-past-toggle {
        margin-left: 0 !important;
        justify-content: center;
    }
    .clubcalendar-widget .fc-col-header-cell-cushion {
        font-size: 11px;
    }
    .clubcalendar-widget .fc-daygrid-day-number {
        font-size: 12px;
    }
    .clubcal-event-time-row {
        font-size: 9px;
    }
    .clubcal-event-title-row {
        font-size: 10px;
    }
    .clubcal-tabs {
        flex-direction: column;
    }
    .clubcal-tab-btn {
        width: 100%;
        text-align: center;
    }
}
        `;

        const style = document.createElement('style');
        style.id = 'clubcalendar-styles';
        style.textContent = css;
        document.head.appendChild(style);
    }


// ╔═══════════════════════════════════════════════════════════════════════════╗
// ║  CATEGORY B: DATA LAYER                                                   ║
// ║  Where data comes from                                                    ║
// ╚═══════════════════════════════════════════════════════════════════════════╝

// ═══════════════════════════════════════════════════════════════════════════
// SECTION 3: EVENT DATA ACCESS (API Integration)               [~12% of code]
// ═══════════════════════════════════════════════════════════════════════════
// Dependencies: fetch API (browser built-in)
// Stability: HIGH | Break risk: LOW (uses WA Member API directly)
//
// This section handles fetching events from Wild Apricot's Member API.
// Data is fetched client-side and transformed for FullCalendar.
//
// API ENDPOINT: /sys/api/publicview/v1/accounts/{accountId}/events
// Requires: waAccountId, waClientId, logged-in WA member
//
// WHAT YOU MIGHT NEED TO CHANGE:
// - Data transformation if WA API response format changes
// ═══════════════════════════════════════════════════════════════════════════

    /** @type {Array} All loaded events */
    let allEvents = [];

    /** @type {Array} Filtered events for display */
    let filteredEvents = [];

    /** @type {Object} Current filter state - supports multiple active filters (AND logic) */
    let currentFilters = {
        interest: null,
        committee: null,
        time: 'upcoming',
        availability: null,
        timeOfDay: [],           // Can have multiple: ['morning', 'afternoon', 'evening', 'allday']
        memberAvailability: [],  // Can have multiple: ['public', 'available', 'limited', 'waitlist', 'unavailable']
        quickFilters: [],        // ['weekend', 'openings', 'free', 'afterhours', 'newbie']
        cost: null,              // 'free', 'under25', 'under50', 'under100', 'over100'
        showPast: false,         // Show past events
        pastMonths: 0            // Number of months back to show (0 = current only)
    };

    /** @type {Object|null} FullCalendar instance */
    let calendarInstance = null;

    /** @type {number} Timestamp of last data refresh (for debouncing) */
    let lastRefreshTime = 0;

    /** @type {number} Minimum seconds between auto-refreshes */
    const REFRESH_DEBOUNCE_SECONDS = 30;

    /** @type {Date|null} Earliest date for which we have events loaded */
    let earliestLoadedDate = null;

    /** @type {Set} IDs of events the user is registered for */
    let myRegistrations = new Set();

    /** @type {boolean} Whether My Events filter is active */
    let myEventsFilterActive = false;


    /**
     * Fetches events from the configured source.
     * Priority: Client-side API > eventsUrl (JSON file) > useLiveApi > SQLite API
     *
     * @param {number} pastMonths - Number of months back to include (0 = current only)
     * @returns {Promise<Array>} Array of event objects
     */
    async function fetchEvents(pastMonths = 0) {
        // Priority 1: Client-side WA Member API (v1.04)
        if (CONFIG.useClientSideApi && CONFIG.waAccountId && CONFIG.waClientId) {
            return fetchEventsFromMemberApi(pastMonths);
        }

        // v1.04: Only client-side Member API is supported
        throw new Error('Client-side API configuration required (waAccountId and waClientId)');
    }

    /**
     * Fetch events directly from WA Member API (client-side).
     * Requires logged-in user and waClientId configuration.
     *
     * @param {number} pastMonths - Number of months back to include (0 = current only)
     * @returns {Promise<Array>} Array of event objects
     */
    async function fetchEventsFromMemberApi(pastMonths = 0) {
        const accountId = CONFIG.waAccountId;
        const clientId = CONFIG.waClientId;

        if (!accountId || !clientId) {
            throw new Error('waAccountId and waClientId required for client-side API');
        }

        // Calculate date range
        const now = new Date();
        const startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        if (pastMonths > 0) {
            startDate.setMonth(startDate.getMonth() - pastMonths);
        }

        // Build API URL with OData filter
        // WA API uses simple date format: YYYY-MM-DD (no datetime wrapper)
        // Request up to 500 events (WA default is often 20-100)
        const dateStr = startDate.toISOString().split('T')[0];
        const url = `/sys/api/publicview/v1/accounts/${accountId}/events` +
            `?$filter=StartDate ge ${dateStr}` +
            `&$orderby=StartDate` +
            `&$top=500`;

        try {
            const response = await fetch(url, {
                headers: { 'clientId': clientId }
            });

            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    throw new Error('LOGIN_REQUIRED');
                }
                throw new Error(`API error: ${response.status}`);
            }

            const data = await response.json();
            const events = data.Events || [];

            console.log(`ClubCalendar: Fetched ${events.length} events from Member API`);

            return events
                .filter(e => !e.Name || !e.Name.includes('CANCELLED'))
                .map(event => mapMemberApiEventToInternal(event));

        } catch (error) {
            console.error('ClubCalendar: Failed to fetch from Member API:', error);
            throw error;
        }
    }

    /**
     * Maps WA Member API event format to internal event format.
     */
    function mapMemberApiEventToInternal(event) {
        const limit = event.RegistrationsLimit;
        const confirmed = event.ConfirmedRegistrationsCount || 0;
        const spotsAvailable = limit ? limit - confirmed : null;
        const isFull = limit ? confirmed >= limit : false;

        // Determine availability
        let availability = 'unlimited';
        if (limit !== null && limit > 0) {
            const remaining = limit - confirmed;
            if (remaining <= 0) availability = 'full';
            else if (remaining <= 3) availability = 'limited';
            else availability = 'available';
        }

        // Parse tags
        let tagsStr = '';
        if (Array.isArray(event.Tags)) {
            tagsStr = event.Tags.map(t => t.Name || t).join(', ');
        }

        // Check if public
        const isPublic = tagsStr.toLowerCase().includes('public') ||
                         event.AccessLevel === 'Public';

        // Parse description
        let description = '';
        if (event.Details && event.Details.DescriptionHtml) {
            description = event.Details.DescriptionHtml;
        }

        return {
            id: event.Id,
            name: event.Name || '',
            startDate: event.StartDate,
            endDate: event.EndDate,
            location: event.Location || '',
            limit: limit,
            confirmed: confirmed,
            tags: tagsStr,
            status: event.RegistrationEnabled !== false ? 'Active' : 'Disabled',
            minPrice: null,
            maxPrice: null,
            isFree: null,
            hasGuestTickets: null,
            registrationOpenDate: null,
            registrationEnabled: event.RegistrationEnabled,
            accessLevel: event.AccessLevel,
            availability: availability,
            spotsAvailable: spotsAvailable,
            isFull: isFull,
            isPublic: isPublic,
            eventUrl: event.Url || `https://sbnewcomers.org/event-${event.Id}`,
            description: description
        };
    }


    /**
     * Fetches the logged-in user's event registrations from the WA Member API.
     * Uses /contacts/me/eventregistrations endpoint - no email input needed.
     * @returns {Promise<Set>} Set of event IDs the user is registered for
     */
    async function fetchMyRegistrations() {
        const accountId = CONFIG.waAccountId;
        const clientId = CONFIG.waClientId;

        if (!accountId || !clientId) {
            console.log('ClubCalendar: Cannot fetch registrations - missing API credentials');
            return new Set();
        }

        try {
            const url = `/sys/api/publicview/v1/accounts/${accountId}/contacts/me/eventregistrations`;
            const response = await fetch(url, {
                headers: { 'clientId': clientId }
            });

            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    console.log('ClubCalendar: User not logged in, cannot fetch registrations');
                    return new Set();
                }
                throw new Error(`API error: ${response.status}`);
            }

            const data = await response.json();
            const registrations = data.EventRegistrations || data || [];

            // Extract event IDs from registrations
            const eventIds = new Set();
            registrations.forEach(reg => {
                // WA API may return Event.Id or EventId depending on endpoint
                const eventId = reg.Event?.Id || reg.EventId || reg.Id;
                if (eventId) {
                    eventIds.add(eventId);
                }
            });

            console.log(`ClubCalendar: User is registered for ${eventIds.size} events`);
            return eventIds;

        } catch (error) {
            console.error('ClubCalendar: Failed to fetch user registrations:', error);
            return new Set();
        }
    }


    /**
     * Transforms ClubCalendar events into FullCalendar event format.
     *
     * @param {Array} events - Array of event objects
     * @returns {Array} Array of FullCalendar event objects
     */
    // Color mapping for time-of-day (used to override FullCalendar inline styles)
    const TIME_OF_DAY_COLORS = {
        morning:   { bg: '#FFD54F', border: '#F0A020', text: '#000' },  // Yellow
        afternoon: { bg: '#F5A623', border: '#D4881A', text: '#000' },  // Carrot Orange
        evening:   { bg: '#37474F', border: '#263238', text: '#fff' },  // Dark
        allday:    { bg: '#66bb6a', border: '#43a047', text: '#000' }   // Green
    };

    function transformEventsForCalendar(events) {
        return events.map(event => {
            const timeOfDay = deriveTimeOfDay(event.startDate, event.endDate);
            const availability = getAvailability(event);
            const memberAvailability = getMemberAvailability(event);
            const colors = TIME_OF_DAY_COLORS[timeOfDay] || TIME_OF_DAY_COLORS.afternoon;

            return {
                id: event.id,
                title: getCleanTitle(event.name),
                start: event.startDate,
                end: event.endDate,
                classNames: [`clubcal-event-${timeOfDay}`],
                backgroundColor: colors.bg,
                borderColor: colors.border,
                textColor: colors.text,
                extendedProps: {
                    originalEvent: event,
                    category: extractCommittee(event.name),
                    timeOfDay: timeOfDay,
                    location: event.location,
                    availability: availability,
                    memberAvailability: memberAvailability,
                    isFree: event.isFree === 1 || event.minPrice === 0,
                    price: formatPrice(event),
                    tags: parseTags(event.tags)
                }
            };
        });
    }

    /**
     * Determines time-of-day category from event start time for color coding.
     * Morning: before 12pm (orange)
     * Afternoon: 12pm - 5pm (blue)
     * Evening: after 5pm (purple)
     * All-day: no specific time or spans multiple days (green)
     */
    function deriveTimeOfDay(startDate, endDate) {
        if (!startDate) return 'allday';

        const start = new Date(startDate);
        const hour = start.getHours();
        const minutes = start.getMinutes();

        // Check if it's an all-day event (midnight start with no minutes)
        // Only treat as all-day if the event starts exactly at midnight (00:00)
        if (hour === 0 && minutes === 0) {
            return 'allday';
        }

        // Morning: before noon (yellow/sunrise)
        if (hour < 12) {
            return 'morning';
        }
        // Afternoon: noon to 5pm (orange/sunset)
        if (hour < 17) {
            return 'afternoon';
        }
        // Evening: 5pm and later (dark/night)
        return 'evening';
    }

    /**
     * Extracts committee name from event title prefix.
     */
    function extractCommittee(name) {
        for (const [committee, prefixes] of Object.entries(COMMITTEE_KEYWORDS)) {
            for (const prefix of prefixes) {
                if (name.startsWith(prefix) || name.toUpperCase().startsWith(prefix.toUpperCase())) {
                    return committee;
                }
            }
        }

        const colonIdx = name.indexOf(':');
        if (colonIdx > 0 && colonIdx < 30) {
            return name.substring(0, colonIdx).replace(/[*\-()]/g, '').trim();
        }

        return 'General';
    }

    /**
     * Gets clean event title without committee prefix.
     */
    function getCleanTitle(name) {
        let title = name;

        // Remove committee prefix (e.g., "Wellness: Event Name")
        const colonIdx = title.indexOf(':');
        if (colonIdx > 0 && colonIdx < 30) {
            title = title.substring(colonIdx + 1).trim();
        }

        // Remove parenthetical info like "(Registration Opens...)" or "(SOLD OUT)"
        title = title.replace(/\s*\([^)]*(?:registration|sold out|waitlist|cancelled|full)[^)]*\)\s*/gi, ' ').trim();

        return title;
    }

    /**
     * Calculates event availability.
     */
    function getAvailability(event) {
        if (!event.limit || event.limit === 0) {
            return { spots: null, status: 'unlimited' };
        }

        const spots = event.limit - (event.confirmed || 0);

        if (spots <= 0) {
            return { spots: 0, status: 'full' };
        } else if (spots <= 3) {
            return { spots, status: 'low' };
        } else {
            return { spots, status: 'available' };
        }
    }

    /**
     * Determines event availability status for the current member level.
     * Returns: 'public', 'available', 'limited', 'waitlist', 'unavailable'
     *
     * Ticket type rules:
     * - Newbie: can buy 'newbie' or 'newcomermember' tickets
     * - NewcomerMember: can buy 'newcomermember' tickets only
     * - Alumni: can buy 'alumni' tickets if available
     * - Guest: can buy 'guest' tickets if available
     * - null (public): can only see/buy public events with guest tickets
     *
     * @param {Object} event - Event object with tags, hasGuestTickets, limit, confirmed
     * @returns {Object} { status: string, label: string }
     */
    function getMemberAvailability(event) {
        const tags = parseTags(event.tags);
        const isPublic = tags.includes('public event') || tags.includes('public') || event.hasGuestTickets === 1;
        const memberLevel = CONFIG.memberLevel;
        const availability = getAvailability(event);

        // If event is full, it's waitlist regardless of member level
        if (availability.status === 'full') {
            return { status: 'waitlist', label: 'Waitlist' };
        }

        // Public/guest viewing (not logged in)
        if (memberLevel === 'public') {
            if (isPublic) {
                if (availability.status === 'low') {
                    return { status: 'limited', label: 'Limited spots' };
                }
                return { status: 'public', label: 'Public event' };
            }
            return { status: 'unavailable', label: 'Members only' };
        }

        // Check ticket availability based on member level
        // Note: This is simplified - in production, would check actual ticket types from event data
        const eventName = event.name.toLowerCase();

        switch (memberLevel) {
            case 'Newbie':
                // Newbies can attend most events (newbie or newcomermember tickets)
                if (availability.status === 'low') {
                    return { status: 'limited', label: 'Limited spots' };
                }
                return { status: 'available', label: 'Available' };

            case 'NewcomerMember':
                // NewcomerMembers can attend events with newcomermember tickets
                if (availability.status === 'low') {
                    return { status: 'limited', label: 'Limited spots' };
                }
                return { status: 'available', label: 'Available' };

            case 'Alumni':
                // Alumni can only attend if alumni tickets are available
                // For now, assume alumni can attend public events
                if (isPublic) {
                    if (availability.status === 'low') {
                        return { status: 'limited', label: 'Limited spots' };
                    }
                    return { status: 'available', label: 'Available' };
                }
                return { status: 'unavailable', label: 'No alumni tickets' };

            case 'Guest':
                // Guests can only attend public events with guest tickets
                if (isPublic && event.hasGuestTickets === 1) {
                    if (availability.status === 'low') {
                        return { status: 'limited', label: 'Limited spots' };
                    }
                    return { status: 'public', label: 'Guest tickets available' };
                }
                return { status: 'unavailable', label: 'Members only' };

            default:
                // Unknown member level - treat as available if public
                if (isPublic) {
                    return { status: 'public', label: 'Public event' };
                }
                return { status: 'available', label: 'Available' };
        }
    }

    // ICS download removed in v1.04 slim - use web calendar links instead

    /**
     * Generates a Google Calendar URL for an event.
     * Opens Google Calendar with pre-filled event details.
     */
    function generateGoogleCalendarUrl(event) {
        const startDate = new Date(event.start || event.startDate);
        const endDate = new Date(event.end || event.endDate || event.start || event.startDate);

        // Google Calendar uses YYYYMMDDTHHmmssZ format
        const formatGoogleDate = (date) => {
            return date.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
        };

        const params = new URLSearchParams({
            action: 'TEMPLATE',
            text: event.name || 'Event',
            dates: `${formatGoogleDate(startDate)}/${formatGoogleDate(endDate)}`,
            details: `View event details and register: https://sbnewcomers.org/event-${event.id}`,
            location: event.location || '',
            sf: 'true'
        });

        return `https://calendar.google.com/calendar/render?${params.toString()}`;
    }

    /**
     * Generates an Outlook.com calendar URL for an event.
     * Opens Outlook web calendar with pre-filled event details.
     */
    function generateOutlookUrl(event) {
        const startDate = new Date(event.start || event.startDate);
        const endDate = new Date(event.end || event.endDate || event.start || event.startDate);

        const params = new URLSearchParams({
            path: '/calendar/action/compose',
            rru: 'addevent',
            subject: event.name || 'Event',
            startdt: startDate.toISOString(),
            enddt: endDate.toISOString(),
            body: `View event details and register: https://sbnewcomers.org/event-${event.id}`,
            location: event.location || ''
        });

        return `https://outlook.live.com/calendar/0/deeplink/compose?${params.toString()}`;
    }

    /**
     * Generates a Yahoo Calendar URL for an event.
     */
    function generateYahooUrl(event) {
        const startDate = new Date(event.start || event.startDate);
        const endDate = new Date(event.end || event.endDate || event.start || event.startDate);

        // Yahoo uses YYYYMMDDTHHmmss format (no Z)
        const formatYahooDate = (date) => {
            return date.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}Z/, '');
        };

        // Calculate duration in hours and minutes (HHmm format)
        const durationMs = endDate - startDate;
        const durationHours = Math.floor(durationMs / (1000 * 60 * 60));
        const durationMins = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
        const duration = String(durationHours).padStart(2, '0') + String(durationMins).padStart(2, '0');

        const params = new URLSearchParams({
            v: '60',
            title: event.name || 'Event',
            st: formatYahooDate(startDate),
            dur: duration,
            desc: `View event details and register: https://sbnewcomers.org/event-${event.id}`,
            in_loc: event.location || ''
        });

        return `https://calendar.yahoo.com/?${params.toString()}`;
    }

    /**
     * Formats event price for display.
     * Uses cost category strings (e.g., "Under $25") rather than fake numeric midpoints.
     */
    function formatPrice(event) {
        // Prefer the human-readable category from sync data
        if (event.costCategory) {
            return event.costCategory;
        }
        // Fallback for legacy data with numeric prices
        if (event.isFree === 1 || event.minPrice === 0) {
            return 'Free';
        }
        if (event.minPrice !== null && event.minPrice !== undefined) {
            if (event.minPrice === event.maxPrice || event.maxPrice === null) {
                return '$' + Math.round(event.minPrice);
            }
            return '$' + Math.round(event.minPrice) + '-$' + Math.round(event.maxPrice);
        }
        return '';
    }

    /**
     * Parses tags JSON string.
     */
    function parseTags(tagsStr) {
        if (!tagsStr || tagsStr === '[]') return [];

        // Try JSON parse first (for raw API data)
        try {
            const parsed = JSON.parse(tagsStr);
            return Array.isArray(parsed) ? parsed : [parsed];
        } catch {
            return tagsStr.split(',').map(t => t.trim()).filter(t => t);
        }
    }


// ╔═══════════════════════════════════════════════════════════════════════════╗
// ║  CATEGORY C: UI LAYER                                                     ║
// ║  How it all works together                                                ║
// ╚═══════════════════════════════════════════════════════════════════════════╝

// ═══════════════════════════════════════════════════════════════════════════
// SECTION 4: WIDGET INTEGRATION (Connects ClubCalendar data to FullCalendar)
// CATEGORY C: UI LAYER | ~47% of code | Dependencies: FullCalendar only (vanilla JS for DOM)
// Risk: MEDIUM-HIGH | Breaks if: Library APIs change, HTML structure assumptions fail
// ═══════════════════════════════════════════════════════════════════════════
//
// This section contains the "glue" code that:
// - Builds the HTML structure
// - Populates filter dropdowns
// - Initializes FullCalendar with our settings
// - Handles filter changes and event interactions
//
// WHAT YOU MIGHT NEED TO CHANGE:
// - HTML structure if layout redesign
// - Filter logic if new filter types added
// - FullCalendar options if display requirements change
// ═══════════════════════════════════════════════════════════════════════════

    /**
     * Loads external library dependencies (FullCalendar only - jQuery removed).
     *
     * @param {Function} callback - Called when all dependencies ready
     */
    function loadDependencies(callback) {
        const dependencies = [
            {
                type: 'css',
                url: 'https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.10/index.global.min.css',
                check: () => true // CSS always loads
            },
            {
                type: 'js',
                url: 'https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.10/index.global.min.js',
                check: () => window.FullCalendar
            }
        ];

        let loaded = 0;
        const total = dependencies.length;
        let fullCalendarFailed = false;

        function onLoad() {
            loaded++;
            if (loaded === total) {
                // Check if FullCalendar loaded successfully
                if (!window.FullCalendar) {
                    showFallback(new Error('FullCalendar library failed to load'));
                    return;
                }
                callback();
            }
        }

        dependencies.forEach(dep => {
            if (dep.check && dep.check()) {
                onLoad();
                return;
            }

            if (dep.type === 'css') {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = dep.url;
                link.onload = onLoad;
                link.onerror = () => {
                    console.error('ClubCalendar: Failed to load CSS:', dep.url);
                    onLoad();
                };
                document.head.appendChild(link);
            } else {
                const script = document.createElement('script');
                script.src = dep.url;
                script.onload = onLoad;
                script.onerror = () => {
                    console.error('ClubCalendar: Failed to load JS:', dep.url);
                    if (dep.url.includes('fullcalendar')) {
                        fullCalendarFailed = true;
                    }
                    onLoad();
                };
                document.head.appendChild(script);
            }
        });
    }

    /**
     * Builds and inserts the widget HTML structure.
     *
     * @returns {boolean} True if successful
     */
    function buildWidget() {
        const container = document.querySelector(CONFIG.container);
        if (!container) {
            showFallback(new Error('Container not found: ' + CONFIG.container));
            return false;
        }

        let html = '<div class="clubcalendar-widget">';

        // Header
        if (CONFIG.showHeader) {
            html += `
                <div class="clubcalendar-header">
                    <div class="clubcal-header-row">
                        <h2>${escapeHtml(CONFIG.headerTitle)}</h2>
                        <span class="clubcal-help-icon">?
                            <div class="clubcal-help-tooltip">
                                <h4>How to Find Events</h4>

                                <div class="clubcal-help-section">
                                    <strong>Example: Finding a Weekend Show</strong>
                                    <p>To find a performing arts event this month on a weekend with openings:</p>
                                    <p>1. Select <b>Performing Arts</b> from Interest Area</p>
                                    <p>2. Click <b>Weekend</b> and <b>Has Openings</b> buttons</p>
                                    <p>3. Click any event to see details and register</p>
                                </div>

                                <div class="clubcal-help-section">
                                    <strong>Using Filters</strong>
                                    <p>Filters work together to narrow results. Click multiple buttons to combine them (e.g., Weekend + Free shows only free weekend events).</p>
                                    <p><b>To remove a filter:</b> Click a highlighted button again to turn it off.</p>
                                    <p><b>Clear All:</b> Removes all filters at once.</p>
                                </div>

                                <div class="clubcal-help-section">
                                    <strong>Filter Buttons</strong>
                                    <div class="clubcal-help-dots">
                                        <span class="clubcal-help-dot-item"><span class="dot" style="background:#e91e63"></span> Just Opened</span>
                                        <span class="clubcal-help-dot-item"><span class="dot" style="background:#009688"></span> Opening Soon</span>
                                        <span class="clubcal-help-dot-item"><span class="dot" style="background:#4caf50"></span> Has Openings</span>
                                        <span class="clubcal-help-dot-item"><span class="dot" style="background:#00bcd4"></span> Newbies Only</span>
                                        <span class="clubcal-help-dot-item"><span class="dot" style="background:#8bc34a"></span> Open to Public</span>
                                        <span class="clubcal-help-dot-item"><span class="dot" style="background:#9c27b0"></span> Weekend</span>
                                        <span class="clubcal-help-dot-item"><span class="dot" style="background:#ffc107"></span> Free</span>
                                    </div>
                                </div>

                                <div class="clubcal-help-section">
                                    <strong>Views</strong>
                                    <p><b>Calendar</b> – Monthly grid with colored dots showing event features.</p>
                                    <p><b>List</b> – Scrollable list with more detail visible.</p>
                                </div>

                                <div class="clubcal-help-section">
                                    <strong>Event Background = Time of Day</strong>
                                    <div style="display:flex; flex-direction:column; gap:4px; margin-top:6px;">
                                        <div style="display:flex; align-items:center; gap:8px;">
                                            <span style="display:inline-block; width:80px; padding:4px 8px; border-radius:4px; font-size:10px; background:#FFD54F; color:#333; border-left:3px solid #F0A020;">Morning Event</span>
                                            <span style="font-size:10px; color:#666;">before noon ☀️</span>
                                        </div>
                                        <div style="display:flex; align-items:center; gap:8px;">
                                            <span style="display:inline-block; width:80px; padding:4px 8px; border-radius:4px; font-size:10px; background:#F5A623; color:#333; border-left:3px solid #D4881A;">Afternoon Event</span>
                                            <span style="font-size:10px; color:#666;">noon – 5pm 🌅</span>
                                        </div>
                                        <div style="display:flex; align-items:center; gap:8px;">
                                            <span style="display:inline-block; width:80px; padding:4px 8px; border-radius:4px; font-size:10px; background:#37474F; color:#fff; border-left:3px solid #263238;">Evening Event</span>
                                            <span style="font-size:10px; color:#666;">after 5pm 🌙</span>
                                        </div>
                                        <div style="display:flex; align-items:center; gap:8px;">
                                            <span style="display:inline-block; width:80px; padding:4px 8px; border-radius:4px; font-size:10px; background:#e8f5e9; color:#333; border-left:3px solid #4caf50;">All Day Event</span>
                                            <span style="font-size:10px; color:#666;">no specific time</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </span>
                    </div>
                    <p>Discover events, find your next adventure</p>
                </div>
            `;
        }

        // Tabs (if My Events is enabled AND user is logged in)
        const isLoggedIn = CONFIG.memberLevel && CONFIG.memberLevel !== 'public';
        const showMyEventsTab = CONFIG.showMyEvents && isLoggedIn;
        if (showMyEventsTab) {
            html += `
                <div class="clubcal-tabs">
                    <button class="clubcal-tab-btn active" data-tab="find-events">Find Events</button>
                    <button class="clubcal-tab-btn" data-tab="my-events">My Events</button>
                </div>
            `;
        }

        // Find Events Tab Content
        const tabClass = showMyEventsTab ? 'clubcal-tab-content active' : '';
        html += `<div id="clubcal-tab-find-events" class="${tabClass}">`;

        // Filter bar
        if (CONFIG.showFilters) {
            html += '<div class="clubcal-filter-bar">';

            // View toggle first, then filters
            html += `
                <div class="clubcal-filter-group">
                    <div class="clubcal-view-toggle" style="background: var(--clubcal-primary); padding: 4px;">
                        <button class="clubcal-view-btn active" data-view="dayGridMonth" style="font-weight: 600;">Calendar</button>
                        <button class="clubcal-view-btn" data-view="listMonth" style="font-weight: 600;">List</button>
                    </div>
                </div>
            `;

            // Interest filter and Cost filter side by side
            if (CONFIG.showActivityFilter) {
                html += `
                    <div class="clubcal-filter-group">
                        <label>Interest Area</label>
                        <select id="clubcal-filter-interest">
                            <option value="">All Interests</option>
                            <optgroup label="Food & Drink">
                                <option value="food">Food & Dining</option>
                                <option value="wine">Wine</option>
                                <option value="beer">Beer & Brewery</option>
                            </optgroup>
                            <optgroup label="Arts & Culture">
                                <option value="performing-arts">Performing Arts</option>
                                <option value="visual-arts">Visual Arts</option>
                                <option value="tours">Tours & History</option>
                            </optgroup>
                            <optgroup label="Outdoors & Active">
                                <option value="outdoors">Outdoors</option>
                                <option value="athletic">Athletic</option>
                                <option value="garden">Garden & Nature</option>
                            </optgroup>
                            <optgroup label="Learning & Wellness">
                                <option value="books">Books & Reading</option>
                                <option value="discussion">Discussion</option>
                                <option value="wellness">Wellness</option>
                            </optgroup>
                            <optgroup label="Social">
                                <option value="social">Social / Happy Hour</option>
                                <option value="games">Games</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="clubcal-filter-group">
                        <label>Committee</label>
                        <select id="clubcal-filter-committee">
                            <option value="">All Committees</option>
                            ${Object.keys(COMMITTEE_KEYWORDS).sort().map(c =>
                                `<option value="${c}">${c}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="clubcal-filter-group">
                        <label>Cost</label>
                        <select id="clubcal-filter-cost">
                            <option value="">Any Cost</option>
                            <option value="free">Free</option>
                            <option value="under25">Under $25</option>
                            <option value="under50">Under $50</option>
                            <option value="under100">Under $100</option>
                            <option value="over100">$100+</option>
                        </select>
                    </div>
                    <button class="clubcal-clear-btn" data-action="clearFilters">Clear All</button>
                `;
            }

            html += '</div>'; // End filter bar
        }

        // Filter row - all on one line
        html += `
            <div class="clubcal-filter-row">
                <button class="clubcal-action-btn clubcal-myevents-btn" data-filter="myevents"><span class="clubcal-filter-dot myevents"></span> My Events</button>
                <span style="color:#ccc; margin: 0 4px;">|</span>
                <button class="clubcal-action-btn" data-filter="justopened"><span class="clubcal-filter-dot justopened"></span> Just Opened</button>
                <button class="clubcal-action-btn" data-filter="openingsoon"><span class="clubcal-filter-dot openingsoon"></span> Opening Soon</button>
                <button class="clubcal-action-btn" data-filter="openings"><span class="clubcal-filter-dot openings"></span> Openings for Any Member</button>
                <span style="color:#ccc; margin: 0 4px;">|</span>
                <button class="clubcal-action-btn" data-filter="weekend"><span class="clubcal-filter-dot weekend"></span> Weekend</button>
                <button class="clubcal-action-btn" data-filter="afterhours"><span class="clubcal-filter-dot afterhours"></span> After Hours</button>
                <button class="clubcal-action-btn" data-time="morning"><span class="clubcal-time-filter-dot morning"></span> Morning</button>
                <button class="clubcal-action-btn" data-time="afternoon"><span class="clubcal-time-filter-dot afternoon"></span> Afternoon</button>
                <button class="clubcal-action-btn" data-time="evening"><span class="clubcal-time-filter-dot evening"></span> Evening</button>
                <span style="color:#ccc; margin: 0 4px;">|</span>
                <button class="clubcal-action-btn" data-filter="free"><span class="clubcal-filter-dot free"></span> Free</button>
                <button class="clubcal-action-btn" data-filter="newbie"><span class="clubcal-filter-dot newbie"></span> Openings for Newbies</button>
                <button class="clubcal-action-btn" data-filter="public"><span class="clubcal-filter-dot public"></span> Open to Public</button>
                <button class="clubcal-action-btn" data-avail="limited"><span class="clubcal-avail-dot limited"></span> Few Spots Left</button>
            </div>
            <div id="clubcal-active-filters" class="clubcal-active-filters"></div>
        `;

        // Calendar container
        html += `
            <div class="clubcalendar-content" id="clubcalendar-content">
                <div class="clubcal-loading">Loading calendar...</div>
            </div>
        </div>`; // End Find Events tab content

        // My Events Tab Content - Shows user's registered events
        if (CONFIG.showMyEvents) {
            html += `
            <div id="clubcal-tab-my-events" class="clubcal-tab-content">
                <div style="padding: 12px 0; border-bottom: 1px solid var(--clubcal-border, #ddd); margin-bottom: 12px;">
                    <label style="display: inline-flex; align-items: center; cursor: pointer; font-size: 14px; color: var(--clubcal-text-muted);">
                        <input type="checkbox" id="clubcal-show-past-registrations" style="margin-right: 8px; cursor: pointer;">
                        Show past events
                    </label>
                </div>
                <div id="clubcal-my-events-list" class="clubcal-my-events-list">
                    <div class="clubcal-loading">Loading your registrations...</div>
                </div>
            </div>
            `;
        }

        html += '</div>'; // End widget container

        container.innerHTML = html;

        // Apply custom typography settings if configured
        const widgetEl = container.querySelector('.clubcalendar-widget') || container;
        if (CONFIG.fontFamily) {
            widgetEl.style.fontFamily = CONFIG.fontFamily;
        }
        if (CONFIG.baseFontSize) {
            widgetEl.style.fontSize = CONFIG.baseFontSize;
        }

        // Bind events
        bindFilterEvents();
        bindDelegatedEvents();

        return true;
    }

    /**
     * Binds event listeners for filters and view toggle.
     * Uses vanilla JS (no jQuery dependency).
     */
    function bindFilterEvents() {
        const container = document.querySelector('.clubcalendar-widget');
        if (!container) return;

        // Tab switching
        container.querySelectorAll('.clubcal-tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                switchTab(tab);
            });
        });

        // Filter dropdowns
        ['clubcal-filter-interest', 'clubcal-filter-time', 'clubcal-filter-availability'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('change', applyFilters);
        });

        // View toggle buttons
        container.querySelectorAll('.clubcal-view-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                container.querySelectorAll('.clubcal-view-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const view = btn.dataset.view;
                if (calendarInstance) {
                    calendarInstance.changeView(view);
                }
            });
        });

        // Quick filter buttons
        container.querySelectorAll('.clubcal-quick-filter').forEach(btn => {
            btn.addEventListener('click', () => {
                const filter = btn.dataset.filter;
                quickFilter(filter);
            });
        });

        // My Events email input removed in v1.04 slim

        // My Events "Show past events" checkbox
        const showPastCheckbox = document.getElementById('clubcal-show-past-registrations');
        if (showPastCheckbox) {
            showPastCheckbox.addEventListener('change', () => {
                renderMyEventsList();
            });
        }

        // Action buttons (multiple can be active - AND logic)
        container.querySelectorAll('.clubcal-action-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.classList.toggle('active');

                // Handle different button types
                const filterVal = btn.dataset.filter;
                const timeVal = btn.dataset.time;
                const availVal = btn.dataset.avail;
                const isActive = btn.classList.contains('active');

                if (filterVal) {
                    // Special handling for "My Events" filter
                    if (filterVal === 'myevents') {
                        myEventsFilterActive = isActive;
                        console.log('ClubCalendar: My Events filter', isActive ? 'ON' : 'OFF');
                    } else {
                        // Quick filters (weekend, openings, free, afterhours)
                        if (!currentFilters.quickFilters) currentFilters.quickFilters = [];
                        if (isActive) {
                            if (!currentFilters.quickFilters.includes(filterVal)) {
                                currentFilters.quickFilters.push(filterVal);
                            }
                        } else {
                            currentFilters.quickFilters = currentFilters.quickFilters.filter(f => f !== filterVal);
                        }
                    }
                } else if (timeVal) {
                    // Time of day filters
                    if (!currentFilters.timeOfDay) currentFilters.timeOfDay = [];
                    if (isActive) {
                        if (!currentFilters.timeOfDay.includes(timeVal)) {
                            currentFilters.timeOfDay.push(timeVal);
                        }
                    } else {
                        currentFilters.timeOfDay = currentFilters.timeOfDay.filter(t => t !== timeVal);
                    }
                } else if (availVal) {
                    // Availability filters
                    if (!currentFilters.memberAvailability) currentFilters.memberAvailability = [];
                    if (isActive) {
                        if (!currentFilters.memberAvailability.includes(availVal)) {
                            currentFilters.memberAvailability.push(availVal);
                        }
                    } else {
                        currentFilters.memberAvailability = currentFilters.memberAvailability.filter(a => a !== availVal);
                    }
                }

                filterAndRender();
            });
        });

        // Cost filter dropdown
        const costFilter = document.getElementById('clubcal-filter-cost');
        if (costFilter) {
            costFilter.addEventListener('change', () => {
                currentFilters.cost = costFilter.value || null;
                filterAndRender();
            });
        }

        // Committee filter dropdown
        const committeeFilter = document.getElementById('clubcal-filter-committee');
        if (committeeFilter) {
            committeeFilter.addEventListener('change', () => {
                currentFilters.committee = committeeFilter.value || null;
                filterAndRender();
            });
        }
    }

    /**
     * Binds delegated event handlers for dynamically generated content.
     * This replaces inline onclick handlers with data-action attributes.
     * Uses vanilla JS (no jQuery dependency).
     */
    function bindDelegatedEvents() {
        // Use event delegation on document for popup and dynamic content
        document.addEventListener('click', (e) => {
            const target = e.target.closest('[data-action]');
            if (!target) return;

            const action = target.dataset.action;
            const eventId = target.dataset.eventId;
            const section = target.dataset.section;

            switch (action) {
                case 'closePopup':
                    closeEventPopup();
                    break;
                case 'toggleSection':
                    if (section) togglePopupSection(section);
                    break;
                case 'clearFilters':
                    clearFilters();
                    break;
                case 'openEvent':
                    if (eventId) {
                        window.open(`https://sbnewcomers.org/event-${eventId}`, '_blank');
                    }
                    break;
            }
        });
    }

    /**
     * Reloads events from API (needed when date range changes)
     */
    async function reloadEvents() {
        try {
            allEvents = await fetchEvents(currentFilters.pastMonths);
            filteredEvents = [...allEvents];

            // Update earliest loaded date based on loaded events
            if (allEvents.length > 0) {
                const dates = allEvents.map(e => new Date(e.startDate));
                earliestLoadedDate = new Date(Math.min(...dates));
            }

            filterAndRender();
        } catch (error) {
            showError('Failed to load events. Please try again.');
        }
    }

    /**
     * Switches between Find Events and My Events tabs.
     * Uses vanilla JS (no jQuery dependency).
     */
    function switchTab(tab) {
        // Update tab buttons
        document.querySelectorAll('.clubcal-tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        const activeTabBtn = document.querySelector(`.clubcal-tab-btn[data-tab="${tab}"]`);
        if (activeTabBtn) activeTabBtn.classList.add('active');

        // Update tab content
        document.querySelectorAll('.clubcal-tab-content').forEach(content => {
            content.classList.remove('active');
        });
        const activeTabContent = document.getElementById(`clubcal-tab-${tab}`);
        if (activeTabContent) activeTabContent.classList.add('active');

        // Render My Events list when switching to that tab
        if (tab === 'my-events') {
            renderMyEventsList();
        }
    }

    /**
     * Renders the My Events list showing user's registered events.
     */
    function renderMyEventsList() {
        const container = document.getElementById('clubcal-my-events-list');
        if (!container) return;

        const now = new Date();
        const showPastCheckbox = document.getElementById('clubcal-show-past-registrations');
        const showPast = showPastCheckbox && showPastCheckbox.checked;

        // Filter events to only those the user is registered for
        let myEvents = allEvents.filter(event => myRegistrations.has(event.id));

        // Separate into upcoming and past
        const upcomingEvents = myEvents.filter(event => new Date(event.startDate) >= now);
        const pastEvents = myEvents.filter(event => new Date(event.startDate) < now);

        // Apply past filter
        if (!showPast) {
            myEvents = upcomingEvents;
        }

        if (myEvents.length === 0) {
            const message = showPast
                ? "You haven't registered for any events yet."
                : "You haven't registered for any upcoming events yet.";
            container.innerHTML = `
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 48px; margin-bottom: 16px;">📅</div>
                    <h3 style="margin: 0 0 12px 0; color: var(--clubcal-text);">No ${showPast ? '' : 'Upcoming '}Registrations</h3>
                    <p style="font-size: 14px; color: var(--clubcal-text-muted); margin-bottom: 24px;">
                        ${message}
                    </p>
                    <button onclick="ClubCalendar.switchTab('find-events')" class="clubcal-btn clubcal-btn-primary"
                            style="padding: 12px 24px; font-size: 15px; cursor: pointer;">
                        Browse Events →
                    </button>
                </div>
            `;
            return;
        }

        // Sort by date
        myEvents.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

        let html = `<div style="padding: 16px 0;">`;

        // Summary message
        if (showPast) {
            html += `<p style="font-size: 14px; color: var(--clubcal-text-muted); margin: 0 0 16px 0;">
                ${upcomingEvents.length} upcoming, ${pastEvents.length} past event${pastEvents.length !== 1 ? 's' : ''}.
            </p>`;
        } else {
            html += `<p style="font-size: 14px; color: var(--clubcal-text-muted); margin: 0 0 16px 0;">
                You're registered for ${myEvents.length} upcoming event${myEvents.length !== 1 ? 's' : ''}.
            </p>`;
        }

        myEvents.forEach(event => {
            const eventDate = new Date(event.startDate);
            const isPast = eventDate < now;
            const dateStr = eventDate.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });
            const timeStr = eventDate.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });

            const cardStyle = isPast
                ? 'background: var(--clubcal-bg-light, #f8f9fa); border: 1px solid var(--clubcal-border, #ddd); opacity: 0.7;'
                : 'background: var(--clubcal-bg-light, #f8f9fa); border: 1px solid var(--clubcal-border, #ddd);';

            const badge = isPast
                ? '<span class="clubcal-badge" style="flex-shrink: 0; background: #9e9e9e; color: white;">Past</span>'
                : '<span class="clubcal-badge registered" style="flex-shrink: 0;">✓ Registered</span>';

            html += `
                <div class="clubcal-my-event-card" style="
                    ${cardStyle}
                    border-radius: 8px;
                    padding: 16px;
                    margin-bottom: 12px;
                    cursor: pointer;
                " onclick="window.open('${escapeHtml(event.eventUrl)}', '_blank')">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--clubcal-text); margin-bottom: 4px;">
                                ${escapeHtml(event.name)}
                            </div>
                            <div style="font-size: 13px; color: var(--clubcal-text-muted);">
                                ${dateStr} • ${timeStr}
                            </div>
                            ${event.location ? `<div style="font-size: 13px; color: var(--clubcal-text-muted); margin-top: 4px;">
                                📍 ${escapeHtml(event.location)}
                            </div>` : ''}
                        </div>
                        ${badge}
                    </div>
                </div>
            `;
        });

        html += `</div>`;
        container.innerHTML = html;
    }

    /**
     * Applies current filter settings and refreshes calendar.
     * Uses vanilla JS (no jQuery dependency).
     */
    function applyFilters() {
        // Update dropdown filter values while preserving other filter state
        const interestEl = document.getElementById('clubcal-filter-interest');
        const timeEl = document.getElementById('clubcal-filter-time');
        const availEl = document.getElementById('clubcal-filter-availability');

        currentFilters.interest = interestEl ? (interestEl.value || null) : null;
        currentFilters.time = timeEl ? (timeEl.value || 'upcoming') : 'upcoming';
        currentFilters.availability = availEl ? (availEl.value || null) : null;

        filterAndRender();
    }

    /**
     * Handles quick filter button clicks.
     * Uses vanilla JS (no jQuery dependency).
     */
    function quickFilter(type) {
        // Reset filters
        const interestEl = document.getElementById('clubcal-filter-interest');
        const timeEl = document.getElementById('clubcal-filter-time');
        const availEl = document.getElementById('clubcal-filter-availability');

        if (interestEl) interestEl.value = '';
        if (timeEl) timeEl.value = 'upcoming';
        if (availEl) availEl.value = '';

        // Remove active class from all quick filters
        document.querySelectorAll('.clubcal-quick-filter').forEach(btn => {
            btn.classList.remove('active');
        });

        if (type === 'this-weekend') {
            if (timeEl) timeEl.value = 'weekend';
            const weekendBtn = document.querySelector('[data-filter="this-weekend"]');
            if (weekendBtn) weekendBtn.classList.add('active');
        } else if (type === 'has-openings') {
            if (availEl) availEl.value = 'available';
            const openingsBtn = document.querySelector('[data-filter="has-openings"]');
            if (openingsBtn) openingsBtn.classList.add('active');
        } else if (type === 'free') {
            if (availEl) availEl.value = 'free';
            const freeBtn = document.querySelector('[data-filter="free"]');
            if (freeBtn) freeBtn.classList.add('active');
        }

        applyFilters();
    }

    /**
     * Clears all filters and resets calendar.
     * Uses vanilla JS (no jQuery dependency).
     */
    function clearFilters() {
        // Reset all filter dropdowns
        const filterIds = ['clubcal-filter-interest', 'clubcal-filter-committee',
                          'clubcal-filter-availability', 'clubcal-filter-cost'];
        filterIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });

        // Remove active class from filter buttons
        document.querySelectorAll('.clubcal-quick-filter').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelectorAll('.clubcal-action-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        currentFilters = {
            interest: null,
            committee: null,
            time: 'upcoming',
            availability: null,
            timeOfDay: [],
            memberAvailability: [],
            quickFilters: [],
            cost: null,
            showPast: currentFilters.showPast,  // Keep past selection state
            pastMonths: currentFilters.pastMonths  // Keep past months selection
        };

        // Reset My Events filter
        myEventsFilterActive = false;

        filterAndRender();
    }

    /**
     * Updates the active filters display showing current filter selections.
     */
    function updateActiveFiltersDisplay() {
        const container = document.getElementById('clubcal-active-filters');
        if (!container) return;

        const tags = [];

        // Interest
        if (currentFilters.interest) {
            const interestLabels = {
                'food': 'Food & Dining', 'wine': 'Wine', 'beer': 'Beer & Brewery',
                'performing-arts': 'Performing Arts', 'visual-arts': 'Visual Arts', 'tours': 'Tours',
                'outdoors': 'Outdoors', 'athletic': 'Athletic', 'garden': 'Garden',
                'books': 'Books', 'discussion': 'Discussion', 'wellness': 'Wellness',
                'social': 'Social', 'games': 'Games'
            };
            tags.push(`<span class="clubcal-active-filter-tag"><span class="clubcal-active-filter-label">Interest:</span> ${interestLabels[currentFilters.interest] || currentFilters.interest}</span>`);
        }

        // Committee
        if (currentFilters.committee) {
            tags.push(`<span class="clubcal-active-filter-tag"><span class="clubcal-active-filter-label">Committee:</span> ${currentFilters.committee}</span>`);
        }

        // Cost
        if (currentFilters.cost) {
            const costLabels = {
                'free': 'Free', 'under25': 'Under $25', 'under50': 'Under $50',
                'under100': 'Under $100', 'over100': '$100+'
            };
            tags.push(`<span class="clubcal-active-filter-tag"><span class="clubcal-active-filter-label">Cost:</span> ${costLabels[currentFilters.cost] || currentFilters.cost}</span>`);
        }

        // Quick filters
        const quickFilterLabels = {
            'weekend': 'Weekend', 'openings': 'Openings for Any Member', 'free': 'Free',
            'afterhours': 'After Hours', 'newbie': 'Openings for Newbies',
            'justopened': 'Just Opened', 'openingsoon': 'Opening Soon'
        };
        (currentFilters.quickFilters || []).forEach(qf => {
            tags.push(`<span class="clubcal-active-filter-tag">${quickFilterLabels[qf] || qf}</span>`);
        });

        // Time of day
        const timeLabels = { 'morning': 'Morning', 'afternoon': 'Afternoon', 'evening': 'Evening' };
        (currentFilters.timeOfDay || []).forEach(t => {
            tags.push(`<span class="clubcal-active-filter-tag">${timeLabels[t] || t}</span>`);
        });

        // Member availability
        const availLabels = { 'public': 'Guests Welcome', 'available': 'Spots Open', 'limited': 'Few Spots Left' };
        (currentFilters.memberAvailability || []).forEach(a => {
            tags.push(`<span class="clubcal-active-filter-tag">${availLabels[a] || a}</span>`);
        });

        // My Events filter
        if (myEventsFilterActive) {
            tags.push(`<span class="clubcal-active-filter-tag" style="background:var(--clubcal-dot-myevents);color:white;">My Events</span>`);
        }

        // Show count if filters active
        if (tags.length > 0) {
            tags.unshift(`<span class="clubcal-filter-count">${filteredEvents.length} event${filteredEvents.length !== 1 ? 's' : ''}</span>`);
        }

        container.innerHTML = tags.join('');
    }

    /**
     * Filters events based on current filter state.
     */
    function filterAndRender() {
        const now = new Date();
        const endOfWeek = new Date(now);
        endOfWeek.setDate(now.getDate() + (7 - now.getDay()));

        const startOfNextWeek = new Date(endOfWeek);
        startOfNextWeek.setDate(endOfWeek.getDate() + 1);

        const endOfNextWeek = new Date(startOfNextWeek);
        endOfNextWeek.setDate(startOfNextWeek.getDate() + 6);

        const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);

        filteredEvents = allEvents.filter(event => {
            const eventDate = new Date(event.startDate);
            const eventHour = eventDate.getHours();
            const nameLower = event.name.toLowerCase();
            const availability = getAvailability(event);
            const memberAvail = getMemberAvailability(event);
            const timeOfDay = deriveTimeOfDay(event.startDate, event.endDate);
            const isFree = event.isFree === 1 || event.minPrice === 0;
            const dayOfWeek = eventDate.getDay();

            // My Events filter - only show events user is registered for
            if (myEventsFilterActive) {
                if (!myRegistrations.has(event.id)) return false;
            }

            // NOTE: For external server version, show ALL events to public
            // but with limited info on click (location, registrants hidden)
            // Original filter disabled to show full calendar preview
            // if (memberAvail.status === 'unavailable') return false;

            // Interest filter (from dropdown)
            if (currentFilters.interest) {
                const keywords = INTEREST_KEYWORDS[currentFilters.interest] || [];
                const matches = keywords.some(kw => nameLower.includes(kw.toLowerCase()));
                if (!matches) return false;
            }

            // Quick filters (AND logic - all must match)
            if (currentFilters.quickFilters && currentFilters.quickFilters.length > 0) {
                for (const qf of currentFilters.quickFilters) {
                    if (qf === 'weekend' && dayOfWeek !== 0 && dayOfWeek !== 6) return false;
                    if (qf === 'openings' && availability.status === 'full') return false;
                    if (qf === 'free' && !isFree) return false;
                    if (qf === 'afterhours') {
                        // After Hours = weekends OR after 5pm on weekdays
                        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                        const isAfter5pmWeekday = dayOfWeek >= 1 && dayOfWeek <= 5 && eventHour >= 17;
                        if (!isWeekend && !isAfter5pmWeekday) return false;
                    }
                    if (qf === 'newbie') {
                        const eventTags = parseTags(event.tags);
                        const isNewbieFriendly = eventTags.some(t =>
                            t.toLowerCase().includes('newbie') ||
                            t.toLowerCase().includes('new member') ||
                            t.toLowerCase().includes('orientation')
                        );
                        if (!isNewbieFriendly) return false;
                    }
                    if (qf === 'justopened') {
                        // Just Opened = registration opened within the last 7 days
                        if (!event.registrationOpenDate) return false;
                        const regOpenDate = new Date(event.registrationOpenDate);
                        const sevenDaysAgo = new Date(now);
                        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                        if (regOpenDate < sevenDaysAgo || regOpenDate > now) return false;
                    }
                    if (qf === 'openingsoon') {
                        // Opening Soon = registration opens within the next 7 days
                        if (!event.registrationOpenDate) return false;
                        const regOpenDate = new Date(event.registrationOpenDate);
                        const sevenDaysFromNow = new Date(now);
                        sevenDaysFromNow.setDate(sevenDaysFromNow.getDate() + 7);
                        if (regOpenDate <= now || regOpenDate > sevenDaysFromNow) return false;
                    }
                    if (qf === 'public') {
                        // Public events only = tagged as public or has guest tickets
                        const eventTags = parseTags(event.tags);
                        const isPublic = eventTags.some(t =>
                            t.toLowerCase() === 'public' ||
                            t.toLowerCase() === 'public event'
                        ) || event.hasGuestTickets === 1;
                        if (!isPublic) return false;
                    }
                }
            }

            // Time of day filters (OR logic within group, but AND with other groups)
            if (currentFilters.timeOfDay && currentFilters.timeOfDay.length > 0) {
                if (!currentFilters.timeOfDay.includes(timeOfDay)) return false;
            }

            // Member availability filters (OR logic within group)
            if (currentFilters.memberAvailability && currentFilters.memberAvailability.length > 0) {
                if (!currentFilters.memberAvailability.includes(memberAvail.status)) return false;
            }

            // Cost filter - using category strings directly (cleaner than fake numeric midpoints)
            if (currentFilters.cost) {
                const category = event.costCategory || '';
                if (currentFilters.cost === 'free' && category !== 'Free') return false;
                if (currentFilters.cost === 'under25' && !['Free', 'Under $25'].includes(category)) return false;
                if (currentFilters.cost === 'under50' && !['Free', 'Under $25', '$25-50'].includes(category)) return false;
                if (currentFilters.cost === 'under100' && !['Free', 'Under $25', '$25-50', '$50-100'].includes(category)) return false;
                if (currentFilters.cost === 'over100' && category !== 'Over $100') return false;
            }

            // Committee filter (based on event name prefix)
            if (currentFilters.committee) {
                const prefixes = COMMITTEE_KEYWORDS[currentFilters.committee] || [];
                const matchesCommittee = prefixes.some(prefix =>
                    event.name.startsWith(prefix) ||
                    event.name.toLowerCase().startsWith(prefix.toLowerCase())
                );
                if (!matchesCommittee) return false;
            }

            return true;
        });

        // Update active filters display
        updateActiveFiltersDisplay();

        // Update calendar
        if (calendarInstance) {
            calendarInstance.removeAllEvents();
            calendarInstance.addEventSource(transformEventsForCalendar(filteredEvents));
        }
    }

    /**
     * Initializes the FullCalendar instance.
     */
    function initCalendar() {
        const calendarEl = document.getElementById('clubcalendar-content');
        calendarEl.innerHTML = '';

        calendarInstance = new FullCalendar.Calendar(calendarEl, {
            initialView: CONFIG.defaultView,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: ''
            },
            dayHeaderFormat: window.innerWidth < 600 ? { weekday: 'short' } : { weekday: 'long' },  // Short names on mobile
            events: transformEventsForCalendar(filteredEvents),
            eventClick: handleEventNavigate,  // Navigate to event page on click
            displayEventTime: false,  // We'll handle time display ourselves
            dayMaxEvents: false,  // Allow cells to expand
            datesSet: handleCalendarDatesChange,  // Detect navigation to past months
            eventContent: function(arg) {
                const props = arg.event.extendedProps;
                const originalEvent = props.originalEvent;
                const availability = props.availability;
                const isFree = props.isFree;
                const eventTags = props.tags || [];

                // Format time
                const startDate = new Date(originalEvent.startDate);
                const timeStr = startDate.toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                }).toLowerCase();

                // Calculate which filter criteria this event matches
                const dayOfWeek = startDate.getDay();
                const eventHour = startDate.getHours();
                const dots = [];

                // Weekend (purple dot)
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    dots.push('<span class="clubcal-filter-dot weekend" title="Weekend"></span>');
                }
                // Has Openings (green dot)
                if (availability && availability.status !== 'full') {
                    dots.push('<span class="clubcal-filter-dot openings" title="Openings for Any Member"></span>');
                }
                // Free (yellow dot)
                if (isFree) {
                    dots.push('<span class="clubcal-filter-dot free" title="Free"></span>');
                }
                // After Hours (indigo dot) - weekends OR after 5pm on weekdays
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const isAfter5pmWeekday = dayOfWeek >= 1 && dayOfWeek <= 5 && eventHour >= 17;
                if (isWeekend || isAfter5pmWeekday) {
                    dots.push('<span class="clubcal-filter-dot afterhours" title="After Hours"></span>');
                }
                // Openings for Newbies (cyan dot)
                const isNewbieFriendly = eventTags.some(t =>
                    t.toLowerCase().includes('newbie') ||
                    t.toLowerCase().includes('new member') ||
                    t.toLowerCase().includes('orientation')
                );
                if (isNewbieFriendly) {
                    dots.push('<span class="clubcal-filter-dot newbie" title="Openings for Newbies"></span>');
                }

                // Just Opened (pink dot) - registration opened within last 7 days
                const now = new Date();
                let isJustOpened = false;
                let isOpeningSoon = false;
                if (originalEvent.registrationOpenDate) {
                    const regOpenDate = new Date(originalEvent.registrationOpenDate);
                    const sevenDaysAgo = new Date(now);
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    const sevenDaysFromNow = new Date(now);
                    sevenDaysFromNow.setDate(sevenDaysFromNow.getDate() + 7);

                    isJustOpened = regOpenDate >= sevenDaysAgo && regOpenDate <= now;
                    isOpeningSoon = regOpenDate > now && regOpenDate <= sevenDaysFromNow;
                }
                if (isJustOpened) {
                    dots.push('<span class="clubcal-filter-dot justopened" title="Just Opened"></span>');
                }
                // Opening Soon (orange dot)
                if (isOpeningSoon) {
                    dots.push('<span class="clubcal-filter-dot openingsoon" title="Opening Soon"></span>');
                }

                // Registered (checkmark) - user is registered for this event
                const isRegistered = myRegistrations.has(originalEvent.id);
                if (isRegistered) {
                    dots.push('<span class="clubcal-registered-badge" title="You\'re Registered">✓</span>');
                }

                // Shorten title - remove "(Registration Opens...)" and similar
                let shortTitle = arg.event.title
                    .replace(/\s*\(Registration Opens[^)]*\)/gi, '')
                    .replace(/\s*\(Registratio[^)]*\)/gi, '')
                    .replace(/\s*\(Opens[^)]*\)/gi, '')
                    .trim();

                const dotsHtml = dots.length > 0
                    ? `<span class="clubcal-dots-container" style="display:inline-flex;gap:2px;margin-left:4px;">${dots.join('')}</span>`
                    : '';

                // Check if we're in list view
                const isListView = arg.view.type === 'listMonth' || arg.view.type === 'listWeek' || arg.view.type === 'listDay';

                if (isListView) {
                    // List view: show badges with labels instead of dots
                    const badges = [];

                    // Price badge (always show, either "Free" or the cost)
                    const price = props.price;
                    if (isFree) {
                        badges.push('<span class="clubcal-badge free">Free</span>');
                    } else if (price) {
                        badges.push(`<span class="clubcal-badge" style="background:#f5f5f5;color:#333;">${price}</span>`);
                    }

                    if (dayOfWeek === 0 || dayOfWeek === 6) {
                        badges.push('<span class="clubcal-badge weekend">Weekend</span>');
                    }
                    if (availability && availability.status !== 'full') {
                        badges.push('<span class="clubcal-badge openings">Openings for Any Member</span>');
                    }
                    if (isWeekend || isAfter5pmWeekday) {
                        badges.push('<span class="clubcal-badge afterhours">After Hours</span>');
                    }
                    if (isNewbieFriendly) {
                        badges.push('<span class="clubcal-badge newbie">Openings for Newbies</span>');
                    }
                    if (isJustOpened) {
                        badges.push('<span class="clubcal-badge justopened">Just Opened</span>');
                    }
                    if (isOpeningSoon) {
                        badges.push('<span class="clubcal-badge openingsoon">Opening Soon</span>');
                    }
                    if (isRegistered) {
                        badges.push('<span class="clubcal-badge registered">✓ Registered</span>');
                    }
                    const badgesHtml = badges.length > 0
                        ? `<span class="clubcal-badges-container">${badges.join('')}</span>`
                        : '';

                    // Include time in list view - use a badge style for readability
                    const listTimeStr = `<span class="clubcal-badge" style="background:rgba(0,0,0,0.15);color:inherit;font-weight:600;">${timeStr}</span>`;

                    return {
                        html: `<span class="clubcal-event-content-list">${listTimeStr}${shortTitle}${badgesHtml}</span>`
                    };
                }

                // Calendar view: time + dots on first line, title below
                return {
                    html: `
                        <div class="clubcal-event-content">
                            <div class="clubcal-event-time-row">${timeStr}${dotsHtml}</div>
                            <div class="clubcal-event-title-row">${shortTitle}</div>
                        </div>
                    `
                };
            },
            eventDidMount: function(info) {
                // Click-only interaction - no hover popups
                info.el.style.cursor = 'pointer';
            },
            height: 'auto',
            moreLinkClick: 'popover'
        });

        calendarInstance.render();

        // Force recalculate size after layout stabilizes (fixes initial narrow width)
        setTimeout(function() {
            if (calendarInstance) {
                calendarInstance.updateSize();
            }
        }, 100);

        // Add "Past events" dropdown to the calendar toolbar
        const toolbar = calendarEl.querySelector('.fc-toolbar');
        if (toolbar) {
            const maxMonths = CONFIG.pastEventsMonthsList || 6;
            const pastSelector = document.createElement('div');
            pastSelector.className = 'clubcal-past-selector';
            pastSelector.style.marginLeft = 'auto';
            pastSelector.style.display = 'flex';
            pastSelector.style.alignItems = 'center';
            pastSelector.style.gap = '6px';
            pastSelector.style.fontSize = '13px';

            let options = '<option value="0">Current only</option>';
            for (let i = 1; i <= maxMonths; i++) {
                options += `<option value="${i}">${i} month${i > 1 ? 's' : ''} back</option>`;
            }

            pastSelector.innerHTML = `
                <label for="clubcal-past-months" style="color: var(--clubcal-text-muted);">Show:</label>
                <select id="clubcal-past-months" style="padding: 4px 8px; border-radius: 4px; border: 1px solid var(--clubcal-border);">
                    ${options}
                </select>
            `;
            toolbar.appendChild(pastSelector);

            // Bind the change event
            pastSelector.querySelector('select').addEventListener('change', function() {
                const months = parseInt(this.value, 10);
                currentFilters.showPast = months > 0;
                currentFilters.pastMonths = months;
                reloadEvents();
            });
        }
    }

    /**
     * Handles calendar date navigation.
     * When user navigates to a month before our earliest loaded event,
     * automatically fetch more past events.
     */
    async function handleCalendarDatesChange(dateInfo) {
        const viewStart = dateInfo.start;

        // If we haven't set the earliest date yet, set it to start of today
        if (!earliestLoadedDate) {
            const now = new Date();
            earliestLoadedDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        }

        // Check if user navigated to a month before our earliest loaded events
        if (viewStart < earliestLoadedDate) {
            // Calculate how many months back we need to go
            const monthsDiff = (earliestLoadedDate.getFullYear() - viewStart.getFullYear()) * 12
                + (earliestLoadedDate.getMonth() - viewStart.getMonth()) + 1;

            // Update pastMonths in currentFilters and reload
            const newPastMonths = Math.max(currentFilters.pastMonths, monthsDiff);
            if (newPastMonths > currentFilters.pastMonths) {
                console.log(`ClubCalendar: Loading ${newPastMonths} months of past events for navigation`);
                currentFilters.pastMonths = newPastMonths;
                currentFilters.showPast = true;

                // Update the "Past events" dropdown if it exists
                const pastEventsDropdown = document.querySelector('#clubcal-past-events-select select');
                if (pastEventsDropdown) {
                    // Find the closest option value that covers our needs
                    const options = pastEventsDropdown.options;
                    for (let i = 0; i < options.length; i++) {
                        if (parseInt(options[i].value, 10) >= newPastMonths) {
                            pastEventsDropdown.value = options[i].value;
                            break;
                        }
                    }
                }

                // Reload events with the new range
                await reloadEvents();
            }
        }
    }

    /**
     * Handles click on calendar event.
     */
    /**
     * Handles mouse hover over event - shows popup
     */
    function handleEventHover(info) {
        const event = info.event;
        const props = event.extendedProps;
        const originalEvent = props.originalEvent;
        const jsEvent = info.jsEvent;

        showEventPopup({
            title: event.title,
            category: props.category,
            start: event.start,
            end: event.end,
            location: props.location,
            availability: props.availability,
            price: props.price,
            isFree: props.isFree,
            tags: props.tags,
            id: originalEvent.id,
            description: originalEvent.description || ''
        }, jsEvent);  // Pass mouse event for positioning
    }

    /**
     * Handles mouse leaving event - closes popup
     */
    function handleEventHoverOut(info) {
        // Delay closing slightly to allow moving mouse to popup
        hoverCloseTimer = setTimeout(() => {
            closeEventPopup();
        }, 200);
    }

    // Timer for delayed popup close
    let hoverCloseTimer = null;

    /**
     * Handles click on event - navigates to event page
     */
    function handleEventNavigate(info) {
        const event = info.event;
        const props = event.extendedProps;
        const originalEvent = props.originalEvent;
        const availability = props.availability;

        // For members, navigate directly to the event page
        if (CONFIG.memberLevel !== 'public') {
            window.open(`https://sbnewcomers.org/event-${originalEvent.id}`, '_blank');
            return;
        }

        // For public users, show popup with event details
        // Remove any existing popup
        const existing = document.querySelector('.clubcal-event-popup');
        if (existing) existing.remove();

        // Format date/time
        const startDate = new Date(originalEvent.startDate);
        const timeStr = startDate.toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: '2-digit'
        });
        const dateStr = startDate.toLocaleDateString('en-US', {
            weekday: 'long',
            month: 'long',
            day: 'numeric',
            year: 'numeric'
        });

        // Get description (strip images from HTML)
        const description = htmlToReadableText(originalEvent.description || '');

        // Availability status
        let availabilityHtml = '';
        if (availability) {
            if (availability.status === 'full') {
                availabilityHtml = '<span style="color:#c00;">⚠️ Event Full / Waitlist</span>';
            } else if (availability.status === 'low') {
                availabilityHtml = `<span style="color:#f90;">🔥 Only ${availability.spots} spots left!</span>`;
            } else if (availability.spots) {
                availabilityHtml = `<span style="color:#090;">✓ ${availability.spots} spots available</span>`;
            } else {
                availabilityHtml = '<span style="color:#090;">✓ Open registration</span>';
            }
        }

        // Create popup
        const popup = document.createElement('div');
        popup.className = 'clubcal-event-popup';
        popup.innerHTML = `
            <div class="clubcal-hover-tooltip-header">
                <div class="clubcal-hover-tooltip-title">${escapeHtml(event.title)}</div>
                <button class="clubcal-tooltip-close" aria-label="Close">&times;</button>
            </div>
            <div class="clubcal-hover-tooltip-body">
                <div class="clubcal-hover-tooltip-meta">
                    <div>📅 ${dateStr}</div>
                    <div>🕐 ${timeStr}</div>
                    ${availabilityHtml ? `<div>${availabilityHtml}</div>` : ''}
                </div>
                ${description ? `<div class="clubcal-hover-tooltip-desc">${escapeHtml(description)}</div>` : ''}
                <div class="clubcal-hover-tooltip-action">
                    <a href="https://sbnewcomers.org/join" target="_blank" class="clubcal-tooltip-btn">Become a Member to Register →</a>
                </div>
            </div>
        `;
        document.body.appendChild(popup);

        // Close button handler
        popup.querySelector('.clubcal-tooltip-close').addEventListener('click', function(e) {
            e.stopPropagation();
            popup.remove();
        });

        // Position popup near the clicked event
        const rect = info.el.getBoundingClientRect();
        const popupRect = popup.getBoundingClientRect();
        let left = rect.right + 10;
        let top = rect.top;

        // Adjust if off-screen right
        if (left + popupRect.width > window.innerWidth - 20) {
            left = rect.left - popupRect.width - 10;
        }
        // Adjust if off-screen bottom
        if (top + popupRect.height > window.innerHeight - 20) {
            top = window.innerHeight - popupRect.height - 20;
        }
        // Ensure not off-screen
        left = Math.max(10, left);
        top = Math.max(10, top);

        popup.style.left = left + 'px';
        popup.style.top = top + 'px';

        // Click outside to close
        setTimeout(() => {
            document.addEventListener('click', function closeOnOutsideClick(e) {
                if (!popup.contains(e.target) && !info.el.contains(e.target)) {
                    popup.remove();
                    document.removeEventListener('click', closeOnOutsideClick);
                }
            });
        }, 100);
    }

    /**
     * Convert HTML description to readable text with paragraph breaks
     */
    function htmlToReadableText(html) {
        if (!html || html === '{}') return '';
        // Strip images first (they reference WA server and cause 404s)
        html = html.replace(/<img[^>]*>/gi, '');
        // Create a temporary element to parse HTML
        const temp = document.createElement('div');
        temp.innerHTML = html;
        // Replace <br>, <p>, <div> with newlines
        temp.innerHTML = temp.innerHTML
            .replace(/<br\s*\/?>/gi, '\n')
            .replace(/<\/p>/gi, '\n\n')
            .replace(/<\/div>/gi, '\n')
            .replace(/<\/li>/gi, '\n');
        // Get text and clean up
        let text = temp.textContent || temp.innerText || '';
        // Collapse multiple newlines into double newlines (paragraph breaks)
        text = text.replace(/\n{3,}/g, '\n\n').trim();
        return text;
    }

    /**
     * Shows event details popup with expandable sections.
     * @param event - event data object
     * @param jsEvent - mouse event for positioning (optional)
     */
    function showEventPopup(event, jsEvent) {
        // Cancel any pending close timer
        if (hoverCloseTimer) {
            clearTimeout(hoverCloseTimer);
            hoverCloseTimer = null;
        }

        // Remove existing popup
        closeEventPopup();

        const startDate = new Date(event.start);
        const dateStr = startDate.toLocaleDateString('en-US', {
            weekday: 'long',
            month: 'long',
            day: 'numeric',
            year: 'numeric'
        });
        const timeStr = startDate.toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: '2-digit'
        });

        let availabilityHtml = '';
        if (event.availability.status === 'full') {
            availabilityHtml = '<span style="color: #c00;">Sold Out / Waitlist</span>';
        } else if (event.availability.status === 'low') {
            availabilityHtml = `<span style="color: #f90;">Only ${event.availability.spots} spots left!</span>`;
        } else if (event.availability.spots) {
            availabilityHtml = `<span style="color: #090;">${event.availability.spots} spots available</span>`;
        } else {
            availabilityHtml = '<span style="color: #090;">Open registration</span>';
        }

        const tagsHtml = event.tags.includes('public event') || event.tags.includes('public')
            ? '<span style="background:#e8f5e9;color:#2e7d32;padding:2px 8px;border-radius:10px;font-size:11px;">Guests Welcome</span>'
            : '';

        // Convert description HTML to readable text with paragraphs
        const descriptionText = htmlToReadableText(event.description || '');
        const descriptionHtml = descriptionText
            ? `<div class="clubcal-event-popup-description">${descriptionText.split('\n\n').map(p => `<p>${escapeHtml(p)}</p>`).join('')}</div>`
            : '';

        const popupHtml = `
            <div class="clubcal-event-popup clubcal-hover-popup">
                <div class="clubcal-event-popup-header">
                    <span class="clubcal-event-popup-category">${escapeHtml(event.category)}</span>
                    <h3>${escapeHtml(event.title)}</h3>
                </div>
                <div class="clubcal-event-popup-body">
                    <div class="clubcal-event-popup-meta">
                        <div class="clubcal-event-popup-meta-item">
                            <span>📅</span>
                            <strong>${dateStr}</strong>
                        </div>
                        <div class="clubcal-event-popup-meta-item">
                            <span>🕐</span>
                            <strong>${timeStr}</strong>
                        </div>
                        ${event.location && CONFIG.memberLevel !== 'public' ? `
                        <div class="clubcal-event-popup-meta-item">
                            <span>📍</span>
                            <strong>${escapeHtml(event.location)}</strong>
                        </div>
                        ` : ''}
                        ${CONFIG.memberLevel !== 'public' ? `
                        <div class="clubcal-event-popup-meta-item">
                            <span>💰</span>
                            <strong>${event.price || 'See event page'}</strong>
                        </div>
                        <div class="clubcal-event-popup-meta-item">
                            <span>🎟️</span>
                            ${availabilityHtml}
                        </div>
                        ` : `
                        <div class="clubcal-event-popup-meta-item">
                            <span>ℹ️</span>
                            <strong>Members only event</strong>
                        </div>
                        `}
                        ${tagsHtml ? `
                        <div class="clubcal-event-popup-meta-item">
                            ${tagsHtml}
                        </div>
                        ` : ''}
                    </div>

                    ${descriptionHtml}

                    <div class="clubcal-event-popup-actions">
                        ${CONFIG.memberLevel !== 'public' ? `
                        <a href="https://sbnewcomers.org/event-${event.id}" target="_blank" class="clubcal-btn clubcal-btn-primary">
                            View & Register
                        </a>
                        ` : `
                        <a href="https://sbnewcomers.org/join" target="_blank" class="clubcal-btn clubcal-btn-primary">
                            Join SBNC to Register
                        </a>
                        `}
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', popupHtml);

        // Position popup near mouse cursor
        const popup = document.querySelector('.clubcal-hover-popup');
        if (popup && jsEvent) {
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const popupRect = popup.getBoundingClientRect();

            // Start near the mouse position
            let left = jsEvent.clientX + 15;
            let top = jsEvent.clientY + 15;

            // Adjust if popup would go off-screen right
            if (left + popupRect.width > viewportWidth - 20) {
                left = jsEvent.clientX - popupRect.width - 15;
            }

            // Adjust if popup would go off-screen bottom
            if (top + popupRect.height > viewportHeight - 20) {
                top = viewportHeight - popupRect.height - 20;
            }

            // Ensure not off-screen left or top
            left = Math.max(10, left);
            top = Math.max(10, top);

            popup.style.position = 'fixed';
            popup.style.left = left + 'px';
            popup.style.top = top + 'px';
            popup.style.transform = 'none';

            // Add hover handlers to keep popup open
            popup.addEventListener('mouseenter', () => {
                if (hoverCloseTimer) {
                    clearTimeout(hoverCloseTimer);
                    hoverCloseTimer = null;
                }
            });
            popup.addEventListener('mouseleave', () => {
                closeEventPopup();
            });
        }
    }

    /**
     * Toggles an expandable section in the popup.
     */
    function togglePopupSection(sectionId) {
        const section = document.getElementById(`clubcal-${sectionId}-section`);
        if (section) {
            section.classList.toggle('expanded');
        }
    }

    /**
     * Registrant list removed in v1.04 slim - view registrants on WA event page
     */
    async function fetchEventRegistrants(eventId) {
        const listEl = document.getElementById('clubcal-registrants-list');
        if (listEl) {
            listEl.innerHTML = '<div class="clubcal-registrants-empty">View registrants on event page</div>';
        }
    }

    /**
     * Photo gallery removed in v1.04 slim
     */
    async function checkEventPhotos(eventId) {
        // Photos feature requires external server - disabled in v1.04 slim
    }

    /**
     * Closes event popup.
     */
    function closeEventPopup() {
        const overlay = document.querySelector('.clubcal-popup-overlay');
        const popup = document.querySelector('.clubcal-event-popup');
        if (overlay) overlay.remove();
        if (popup) popup.remove();
    }

    /**
     * Escapes HTML special characters.
     */
    function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    /**
     * Shows error message (for non-fatal errors).
     */
    function showError(message) {
        const container = document.getElementById('clubcalendar-content');
        if (container) {
            container.innerHTML = `<div class="clubcal-error">${escapeHtml(message)}</div>`;
        }
    }

    /**
     * Shows fallback WA calendar on fatal error.
     * 1. Hides ClubCalendar container
     * 2. Shows pre-placed WA Calendar container if it exists
     * 3. Shows error message with events link if no fallback container
     */
    function showFallback(error) {
        console.error('ClubCalendar: Fatal error, activating fallback:', error);

        // Hide ClubCalendar container
        const clubCalContainer = document.querySelector(CONFIG.container);
        if (clubCalContainer) {
            clubCalContainer.style.display = 'none';
        }

        // Try to show fallback WA calendar container
        const fallbackContainer = document.getElementById(CONFIG.fallbackContainerId);
        if (fallbackContainer) {
            fallbackContainer.style.display = 'block';
            console.log('ClubCalendar: Fallback WA calendar activated');
            return;
        }

        // No fallback container - show error message with link
        console.log('ClubCalendar: No fallback container found, showing error message');
        if (clubCalContainer) {
            clubCalContainer.style.display = 'block';
            clubCalContainer.innerHTML = `
                <div style="padding: 20px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px;">
                    <h3 style="margin: 0 0 10px 0; color: #856404;">Calendar temporarily unavailable</h3>
                    <p style="margin: 0; color: #856404;">
                        <a href="${escapeHtml(CONFIG.fallbackEventsUrl)}" style="color: #856404; font-weight: 500;">View events list →</a>
                    </p>
                </div>
            `;
        }
    }


    // My Events functionality restored in v1.04 - uses /contacts/me/eventregistrations API


// ═══════════════════════════════════════════════════════════════════════════
// SECTION 5: PUBLIC API
// CATEGORY C: UI LAYER | ~3% of code | Dependencies: Internal functions only
// Risk: LOW | Breaks if: Function signatures change in other sections
// ═══════════════════════════════════════════════════════════════════════════
//
// Functions exposed on window.ClubCalendar for external use.
// These can be called from Wild Apricot page scripts or browser console.
//
// USAGE EXAMPLES:
//   ClubCalendar.clearFilters()        - Reset all filters
//   ClubCalendar.refresh()             - Reload events from API
//   ClubCalendar.getFilters()          - Get current filter state
//   ClubCalendar.changeView('list')    - Switch calendar view
//   ClubCalendar.closePopup()          - Close event popup
// ═══════════════════════════════════════════════════════════════════════════

    /**
     * Public API for external interaction with the calendar.
     * @namespace ClubCalendar
     */
    window.ClubCalendar = {
        /** Initialize the calendar (called automatically) */
        init: init,

        /** Apply current filter values and refresh */
        applyFilters: applyFilters,

        /** Clear all filters */
        clearFilters: clearFilters,

        /** Toggle My Events filter - shows only events user is registered for */
        toggleMyEvents: function() {
            myEventsFilterActive = !myEventsFilterActive;
            const btn = document.querySelector('.clubcal-myevents-btn');
            if (btn) {
                btn.classList.toggle('active', myEventsFilterActive);
            }
            filterAndRender();
            console.log('ClubCalendar: My Events filter', myEventsFilterActive ? 'ON' : 'OFF');
        },

        /** Get user's registered event IDs */
        getMyRegistrations: function() {
            return [...myRegistrations];
        },

        /** Check if user is registered for a specific event */
        isRegistered: function(eventId) {
            return myRegistrations.has(eventId);
        },

        /** Switch between tabs */
        switchTab: switchTab,

        /** Refresh calendar by refetching events */
        refresh: async function() {
            try {
                allEvents = await fetchEvents(currentFilters.pastMonths);
                filteredEvents = [...allEvents];
                filterAndRender();
                lastRefreshTime = Date.now();
                console.log('ClubCalendar: Events refreshed');
            } catch (error) {
                showError('Failed to refresh events. Please try again.');
            }
        },

        /** Refresh if data is stale (for visibility change handler) */
        refreshIfStale: async function() {
            const secondsSinceRefresh = (Date.now() - lastRefreshTime) / 1000;
            if (secondsSinceRefresh >= REFRESH_DEBOUNCE_SECONDS) {
                console.log('ClubCalendar: Tab visible, refreshing (last refresh ' + Math.round(secondsSinceRefresh) + 's ago)');
                await this.refresh();
            } else {
                console.log('ClubCalendar: Tab visible, skipping refresh (last refresh ' + Math.round(secondsSinceRefresh) + 's ago)');
            }
        },

        /** Change calendar view ('month', 'week', 'day', 'list') */
        changeView: function(view) {
            const viewMap = {
                'month': 'dayGridMonth',
                'week': 'timeGridWeek',
                'day': 'timeGridDay',
                'list': 'listMonth'
            };
            const fcView = viewMap[view] || view;
            if (calendarInstance) {
                calendarInstance.changeView(fcView);
            }
        },

        /** Close event popup */
        closePopup: closeEventPopup,

        /** Toggle expandable section in popup */
        toggleSection: togglePopupSection,

        /** Get current configuration */
        getConfig: () => ({ ...CONFIG }),

        /** Get current filter state */
        getFilters: () => ({ ...currentFilters }),

        /** Get loaded events count */
        getEventCount: () => filteredEvents.length
        // downloadIcs removed in v1.04 slim - use web calendar links instead
    };


// ═══════════════════════════════════════════════════════════════════════════
// SECTION 6: INITIALIZATION
// CATEGORY C: UI LAYER | ~4% of code | Dependencies: All previous sections
// Risk: LOW | Breaks if: Container element missing, script load order wrong
// ═══════════════════════════════════════════════════════════════════════════
//
// Main entry point that orchestrates setup.
// Auto-runs when DOM is ready.

    /**
     * Check if user is logged in by calling /contacts/me (for client-side API)
     */
    async function checkLoginStatus() {
        if (!CONFIG.waAccountId || !CONFIG.waClientId) {
            return { loggedIn: false };
        }

        try {
            const url = `/sys/api/publicview/v1/accounts/${CONFIG.waAccountId}/contacts/me`;
            const response = await fetch(url, {
                headers: { 'clientId': CONFIG.waClientId }
            });

            if (response.ok) {
                const data = await response.json();
                return {
                    loggedIn: true,
                    memberLevel: data.MembershipLevel ? data.MembershipLevel.Name : 'Member',
                    email: data.Email,
                    firstName: data.FirstName,
                    lastName: data.LastName
                };
            }
            return { loggedIn: false };
        } catch (e) {
            console.warn('ClubCalendar: Login check failed:', e);
            return { loggedIn: false };
        }
    }

    /**
     * Show login required message
     */
    function showLoginRequired() {
        const container = document.querySelector(CONFIG.container);
        if (container) {
            container.innerHTML = `
                <div class="clubcal-login-required" style="
                    text-align: center;
                    padding: 60px 20px;
                    background: var(--clubcal-info-bg, #e3f2fd);
                    border-radius: 8px;
                    margin: 20px 0;
                ">
                    <h2 style="color: var(--clubcal-primary, #2c5aa0); margin-bottom: 16px;">
                        Members Only
                    </h2>
                    <p style="color: var(--clubcal-text-muted, #666); margin-bottom: 24px;">
                        Please log in to view the club calendar and your event registrations.
                    </p>
                    <a href="/Sys/Login" style="
                        display: inline-block;
                        padding: 12px 32px;
                        background: var(--clubcal-primary, #2c5aa0);
                        color: white;
                        text-decoration: none;
                        border-radius: 6px;
                        font-weight: 600;
                    ">Log In</a>
                </div>
            `;
        }
    }

    /**
     * Main initialization function.
     * 1. Injects CSS
     * 2. Loads external libraries
     * 3. Checks login status (for client-side API)
     * 4. Builds widget HTML
     * 5. Fetches events
     * 6. Initializes calendar
     */
    async function init() {
        injectStyles();
        applyDetectedTheme();  // Auto-detect WA theme colors

        loadDependencies(async function() {
            try {
                // For client-side API, verify user is logged in first
                if (CONFIG.useClientSideApi) {
                    const loginCheck = await checkLoginStatus();
                    if (!loginCheck.loggedIn) {
                        showLoginRequired();
                        return;
                    }
                    // Update member level from API response
                    if (loginCheck.memberLevel) {
                        CONFIG.memberLevel = loginCheck.memberLevel;
                    }
                    console.log(`ClubCalendar: User logged in as ${loginCheck.memberLevel}`);
                }

                // Build widget HTML
                if (!buildWidget()) {
                    return;
                }

                // Fetch user's registrations (for My Events feature)
                myRegistrations = await fetchMyRegistrations();

                // Fetch events (start with current only, user can select past months)
                allEvents = await fetchEvents(0);
                filteredEvents = [...allEvents];
                lastRefreshTime = Date.now();

                // Track earliest loaded date for navigation
                if (allEvents.length > 0) {
                    const dates = allEvents.map(e => new Date(e.startDate));
                    earliestLoadedDate = new Date(Math.min(...dates));
                } else {
                    // Default to start of today if no events
                    const now = new Date();
                    earliestLoadedDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                }

                // Initialize calendar
                initCalendar();

                // Set up visibility change handler for auto-refresh on tab focus
                setupVisibilityHandler();

            } catch (error) {
                if (error.message === 'LOGIN_REQUIRED') {
                    showLoginRequired();
                } else {
                    showFallback(error);
                }
            }
        });
    }

    /**
     * Sets up visibility change handler to refresh data when user returns to tab.
     * Refreshes if data is older than REFRESH_DEBOUNCE_SECONDS.
     */
    function setupVisibilityHandler() {
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                window.ClubCalendar.refreshIfStale();
            }
        });
        console.log('ClubCalendar: Visibility change handler installed (auto-refresh on tab focus)');
    }

    // Auto-initialize when DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

/* ╔═══════════════════════════════════════════════════════════════════════════╗
   ║                                                                           ║
   ║                         CLUBCALENDAR SHIM - END                                   ║
   ║                                                                           ║
   ╚═══════════════════════════════════════════════════════════════════════════╝ */

})();
</script>
