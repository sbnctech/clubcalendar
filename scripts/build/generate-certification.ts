#!/usr/bin/env npx tsx
/**
 * Certification Test Generator
 *
 * Generates certification tests for a given build profile.
 *
 * Usage:
 *   npx tsx scripts/build/generate-certification.ts <profile-name>
 *   npx tsx scripts/build/generate-certification.ts --config path/to/config.json
 */

import * as fs from 'fs';
import * as path from 'path';

interface AutoTagRule {
  type: 'name-prefix' | 'name-contains' | 'name-suffix';
  pattern: string;
  tag: string;
}

interface BuildConfig {
  organizationName: string;
  organizationShortName: string;
  waAccountId: string;
  headerTitle?: string;
  primaryColor?: string;
  accentColor?: string;
  autoTagRules?: AutoTagRule[];
  quickFilters?: Record<string, boolean>;
  dropdownFilters?: Record<string, boolean>;
  publicConfig?: any;
  memberConfig?: any;
  [key: string]: any;
}

// Load built-in profiles from build-widget.ts would be imported here
// For now, we'll load from JSON configs

function generateProfileTs(config: BuildConfig): string {
  const shortName = config.organizationShortName.toUpperCase();
  const varName = shortName.replace(/[^A-Z0-9]/g, '_');

  return `/**
 * ${config.organizationName} Build Profile
 *
 * Auto-generated by generate-certification.ts
 */

import { BuildProfile } from './config-schema';

export const ${varName}_AUTO_TAG_RULES = ${JSON.stringify(config.autoTagRules || [], null, 2)};

export const ${varName}_PROFILE: BuildProfile = {
  name: '${shortName}',
  description: '${config.organizationName}',
  config: ${JSON.stringify({
    waAccountId: config.waAccountId,
    headerTitle: config.headerTitle || 'Events',
    primaryColor: config.primaryColor,
    accentColor: config.accentColor,
    autoTagRules: config.autoTagRules,
    quickFilters: config.quickFilters,
    dropdownFilters: config.dropdownFilters,
    publicConfig: config.publicConfig,
    memberConfig: config.memberConfig,
  }, null, 4)},
  expectedBehaviors: [
    {
      description: 'WA Account ID is set to ${shortName} (${config.waAccountId})',
      test: (config) => config.waAccountId === '${config.waAccountId}',
    },
    {
      description: 'Has ${config.autoTagRules?.length || 0} auto-tag rules',
      test: (config) => config.autoTagRules.length === ${config.autoTagRules?.length || 0},
    },
  ],
  sampleEventTitles: [
${(config.autoTagRules || []).map(rule =>
    `    '${rule.pattern} Sample Event',`
  ).join('\n')}
  ],
};
`;
}

function generateTestTs(config: BuildConfig): string {
  const shortName = config.organizationShortName.toUpperCase();
  const varName = shortName.replace(/[^A-Z0-9]/g, '_');
  const lowerName = config.organizationShortName.toLowerCase();

  return `/**
 * ${config.organizationName} Build Certification Tests
 *
 * Auto-generated by generate-certification.ts
 * Run with: npm run test:certify:${lowerName}
 */

import { describe, it, expect, beforeAll } from 'vitest';
import { applyAutoTags } from '../../widget/src/core';
import { DEFAULT_CONFIG, ClubCalendarConfig } from './config-schema';
import { ${varName}_PROFILE, ${varName}_AUTO_TAG_RULES } from './${lowerName}-profile';

function mergeConfig(base: ClubCalendarConfig, overrides: Partial<ClubCalendarConfig>): ClubCalendarConfig {
  const result = { ...base };
  for (const key of Object.keys(overrides) as (keyof ClubCalendarConfig)[]) {
    const value = overrides[key];
    if (value !== null && typeof value === 'object' && !Array.isArray(value)) {
      (result as any)[key] = { ...(result as any)[key], ...value };
    } else if (value !== undefined) {
      (result as any)[key] = value;
    }
  }
  return result;
}

describe('${shortName} Build Profile Validation', () => {
  let config: ClubCalendarConfig;

  beforeAll(() => {
    config = mergeConfig(DEFAULT_CONFIG, ${varName}_PROFILE.config);
  });

  it('should have valid profile definition', () => {
    expect(${varName}_PROFILE.name).toBe('${shortName}');
    expect(${varName}_PROFILE.config.waAccountId).toBe('${config.waAccountId}');
  });

  describe('Expected behaviors', () => {
    for (const behavior of ${varName}_PROFILE.expectedBehaviors) {
      it(behavior.description, () => {
        expect(behavior.test(config)).toBe(true);
      });
    }
  });
});

describe('${shortName} Auto-Tag Rules', () => {
  it('should have ${config.autoTagRules?.length || 0} rules', () => {
    expect(${varName}_AUTO_TAG_RULES.length).toBe(${config.autoTagRules?.length || 0});
  });

${(config.autoTagRules || []).map((rule, i) => `
  it('rule ${i + 1}: "${rule.pattern}" → "${rule.tag}"', () => {
    const tags = applyAutoTags({ Name: '${rule.pattern} Test Event' }, ${varName}_AUTO_TAG_RULES);
    expect(tags).toContain('${rule.tag}');
  });
`).join('')}
});

describe('${shortName} Certification Summary', () => {
  it('should report certification stats', () => {
    console.log('\\n═══════════════════════════════════════════════════════════════');
    console.log('${shortName} BUILD CERTIFICATION SUMMARY');
    console.log('═══════════════════════════════════════════════════════════════');
    console.log(\`Build Profile: \${${varName}_PROFILE.name}\`);
    console.log(\`WA Account ID: \${${varName}_PROFILE.config.waAccountId}\`);
    console.log(\`Auto-Tag Rules: \${${varName}_AUTO_TAG_RULES.length}\`);
    console.log('═══════════════════════════════════════════════════════════════\\n');
  });
});
`;
}

async function main() {
  const args = process.argv.slice(2);

  if (args.length === 0 || args[0] === '--help') {
    console.log(`
Certification Test Generator

Usage:
  npx tsx scripts/build/generate-certification.ts --config <path/to/config.json>

This will generate:
  - tests/certification/<name>-profile.ts
  - tests/certification/<name>-certification.test.ts
`);
    process.exit(0);
  }

  let config: BuildConfig;

  if (args[0] === '--config') {
    const configPath = args[1];
    if (!configPath || !fs.existsSync(configPath)) {
      console.error('Error: Config file not found:', configPath);
      process.exit(1);
    }
    config = JSON.parse(fs.readFileSync(configPath, 'utf-8'));
  } else {
    console.error('Error: Use --config <file.json> to specify configuration');
    process.exit(1);
  }

  const scriptDir = path.dirname(new URL(import.meta.url).pathname);
  const certDir = path.join(scriptDir, '../../tests/certification');
  const lowerName = config.organizationShortName.toLowerCase().replace(/[^a-z0-9]/g, '-');

  // Generate profile
  const profilePath = path.join(certDir, `${lowerName}-profile.ts`);
  fs.writeFileSync(profilePath, generateProfileTs(config));
  console.log(`✅ Generated: ${profilePath}`);

  // Generate tests
  const testPath = path.join(certDir, `${lowerName}-certification.test.ts`);
  fs.writeFileSync(testPath, generateTestTs(config));
  console.log(`✅ Generated: ${testPath}`);

  console.log(`\nNext steps:`);
  console.log(`  1. Review generated files`);
  console.log(`  2. Add to package.json: "test:certify:${lowerName}": "vitest run tests/certification/${lowerName}-certification.test.ts"`);
  console.log(`  3. Run: npm run test:certify:${lowerName}`);
}

main().catch(console.error);
